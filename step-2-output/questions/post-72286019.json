{"Id": "72286019", "PostTypeId": "1", "AcceptedAnswerId": "72286730", "CreationDate": "2022-05-18T08:52:47.347", "Score": "1", "ViewCount": "696", "Body": "<p>I am trying to create Amazon RDS instances in different environments using CloudFormation templates. There is a Multi-AZ requirement in Prod, but other environments do not need Multi-AZ. This calls for a condition function in CloudFormation.</p>\n<p>Based on the <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-rds-database-instance.html\" rel=\"nofollow noreferrer\">RDS CloudFormation docs</a> and using the <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-conditions.html#intrinsic-function-reference-conditions-if\" rel=\"nofollow noreferrer\">if condition in CloudFormation</a>, the following should work in the template:</p>\n<pre><code>Conditions:\n  IsProd: !Equals [ !Ref EnvironmentType, prod ]\n...\nResources:\n  MyRDSInstance:\n    Properties:\n      ...\n      AvailabilityZone:\n        !If [ IsProd, AWS::NoValue, af-south-1a ]\n      ...\n      MultiAZ: !If [ IsProd, true, false ]\n</code></pre>\n<p>When <code>IsProd</code> evaluates to:</p>\n<ul>\n<li>false, <code>AvailabilityZone: af-south-1a</code> and <code>MultiAZ: false</code></li>\n<li>true, <code>AvailabilityZone</code> <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-conditions.html#:%7E:text=You%20can%20use%20the%20AWS%3A%3ANoValue%20pseudo%20parameter%20as%20a%20return%20value%20to%20remove%20the%20corresponding%20property.\" rel=\"nofollow noreferrer\">is removed</a> and <code>MultiAZ: true</code>, which meets the requirement specified in the <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-rds-database-instance.html#:%7E:text=You%20can%27t%20set%20the%20AvailabilityZone%20parameter%20if%20the%20MultiAZ%20parameter%20is%20set%20to%20true.\" rel=\"nofollow noreferrer\">docs</a>:</li>\n</ul>\n<blockquote>\n<p>You can't set the AvailabilityZone parameter if the MultiAZ parameter is set to true.</p>\n</blockquote>\n<p>However, when trying to deploy the prod RDS instance, I still get the following error in CloudFormation when creating the stack, which then prevents the resources from being created at all:</p>\n<blockquote>\n<p>Requesting a specific availability zone is not valid for Multi-AZ instances. (Service: AmazonRDS; Status Code: 400; Error Code: InvalidParameterCombination; Request ID: e6177fe4-4a4b-4db3-ba66-5f0e0f7218eb; Proxy: null)</p>\n</blockquote>\n<p>I suspect this is a bug in AWS due to a recent change that was applied in the source code, even though it was related to the CDK and not CloudFormation:</p>\n<ul>\n<li>Issue: <a href=\"https://github.com/aws/aws-cdk/issues/10949\" rel=\"nofollow noreferrer\">Availability Zone parameter silently removed from stack when MultiAZ is true</a></li>\n<li>Fix committed on May 25, 2021: fix(rds): <a href=\"https://github.com/aws/aws-cdk/commit/fd8445ff1bf94b3dde26211c497bda7211b54dc0\" rel=\"nofollow noreferrer\">Add exception throw when az is defined for multi-az db inst\u2026</a>. I am getting the error thrown in this exact fix.</li>\n</ul>\n<p>Could it be that CloudFormation is now not making provision for the <code>AWS::NoValue</code> pseudo parameter? If this is a bug in the source code, is there any way to get around this so I can still achieve Multi-AZ in the prod environment only?</p>\n", "OwnerUserId": "5294065", "LastEditorUserId": "5294065", "LastEditDate": "2022-05-18T09:02:12.687", "LastActivityDate": "2022-05-18T09:47:08.533", "Title": "Does Amazon CloudFormation make provision for deploying RDS instances to different environments in a Multi-AZ configuration?", "Tags": "|aws-cloudformation|amazon-rds|", "AnswerCount": "1", "CommentCount": "2", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "127709634", "PostId": "72286019", "Score": "0", "Text": "TL;DR, the solution is to correct the pseudo parameter from `AWS::NoValue` to `!Ref AWS::NoValue`", "CreationDate": "2022-05-18T10:37:43.457", "UserId": "5294065", "filtered-sentences": []}, {"Id": "127710049", "PostId": "72286019", "Score": "1", "Text": "Just to clarify, the CDK issue and PR mentioned are strictly related to CDK that produces CloudFormation code before applying it, but is not related with CloudFormation itself. CDK is a framework on top of CloudFormation :)", "CreationDate": "2022-05-18T10:56:30.017", "UserId": "5479627", "filtered-sentences": []}], "history": [{"Id": "270399511", "PostHistoryTypeId": "2", "PostId": "72286019", "RevisionGUID": "fca6d1bb-169e-4580-a528-0706d6b9968e", "CreationDate": "2022-05-18T08:52:47.347", "UserId": "5294065", "Text": "I am trying to create Amazon RDS instances in different environments using CloudFormation templates. There is a Multi-AZ requirement in Prod, but other environments do not need Multi-AZ. This calls for a condition function in CloudFormation.\r\n\r\nBased on the [RDS CloudFormation docs][1] and using the [if condition in CloudFormation][2], the following should work in the template:\r\n\r\n```\r\nConditions:\r\n  IsProd: !Equals [ !Ref EnvironmentType, prod ]\r\n...\r\nResources:\r\n  MyRDSInstance:\r\n    Properties:\r\n      ...\r\n      AvailabilityZone:\r\n        !If [ IsProd, AWS::NoValue, af-south-1a ]\r\n      ...\r\n      MultiAZ: !If [ IsProd, true, false ]\r\n```\r\n\r\nWhen `IsProd` evaluates to:\r\n- false, `AvailabilityZone: af-south-1a` and `MultiAZ: false`\r\n- true, `AvailabilityZone` [is removed][3] and `MultiAZ: true`, which meets the requirement specified in the [docs][4]: \r\n>You can't set the AvailabilityZone parameter if the MultiAZ parameter is set to true.\r\n\r\nHowever, when trying to deploy the prod RDS instance, I still get the following error in CloudFormation when creating the stack, which then prevents the resources from being created at all:\r\n\r\n> Requesting a specific availability zone is not valid for Multi-AZ instances. (Service: AmazonRDS; Status Code: 400; Error Code: InvalidParameterCombination; Request ID: e6177fe4-4a4b-4db3-ba66-5f0e0f7218eb; Proxy: null)\r\n\r\nI suspect this is a bug in AWS due to a recent change that was applied in the source code:\r\n- Issue: [Availability Zone parameter silently removed from stack when MultiAZ is true][5]\r\n- Fix committed on May 25, 2021: fix(rds): [Add exception throw when az is defined for multi-az db inst\u2026][6]. I am getting the error thrown in this exact fix.\r\n\r\nCould it be that CloudFormation is now not making provision for the `AWS::NoValue` pseudo parameter? If this is a bug in the source code, is there any way to get around this so I can still achieve Multi-AZ in the prod environment only?\r\n\r\n\r\n  [1]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-rds-database-instance.html\r\n  [2]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-conditions.html#intrinsic-function-reference-conditions-if\r\n  [3]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-conditions.html#:~:text=You%20can%20use%20the%20AWS%3A%3ANoValue%20pseudo%20parameter%20as%20a%20return%20value%20to%20remove%20the%20corresponding%20property.\r\n  [4]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-rds-database-instance.html#:~:text=You%20can%27t%20set%20the%20AvailabilityZone%20parameter%20if%20the%20MultiAZ%20parameter%20is%20set%20to%20true.\r\n  [5]: https://github.com/aws/aws-cdk/issues/10949\r\n  [6]: https://github.com/aws/aws-cdk/commit/fd8445ff1bf94b3dde26211c497bda7211b54dc0", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "However, when trying to deploy the prod RDS instance, I still get the following error in CloudFormation when creating the stack, which then prevents the resources from being created at all: ", "keywords": ["instance"]}, {"source": "Text", "text": "(Service: AmazonRDS; Status Code: 400; Error Code: InvalidParameterCombination; Request ID: e6177fe4-4a4b-4db3-ba66-5f0e0f7218eb; Proxy: null) I suspect this is a bug in AWS due to a recent change that was applied in the source code: - Issue: [Availability Zone parameter silently removed from stack when MultiAZ is true][5] - Fix committed on May 25, 2021: fix(rds): [Add exception throw when az is defined for multi-az db inst\u2026][6]. ", "keywords": ["change"]}, {"source": "Text", "text": "If this is a bug in the source code, is there any way to get around this so I can still achieve Multi-AZ in the prod environment only? [1]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-rds-database-instance.html [2]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-conditions.html#intrinsic-function-reference-conditions-if [3]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-conditions.html#:~:text=You%20can%20use%20the%20AWS%3A%3ANoValue%20pseudo%20parameter%20as%20a%20return%20value%20to%20remove%20the%20corresponding%20property. [4]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-rds-database-instance.html#:~:text=You%20can%27t%20set%20the%20AvailabilityZone%20parameter%20if%20the%20MultiAZ%20parameter%20is%20set%20to%20true. [5]: https://github.com/aws/aws-cdk/issues/10949 [6]: https://github.com/aws/aws-cdk/commit/fd8445ff1bf94b3dde26211c497bda7211b54dc0", "keywords": ["instance"]}]}, {"Id": "270399513", "PostHistoryTypeId": "1", "PostId": "72286019", "RevisionGUID": "fca6d1bb-169e-4580-a528-0706d6b9968e", "CreationDate": "2022-05-18T08:52:47.347", "UserId": "5294065", "Text": "Does Amazon CloudFormation make provision for deploying RDS instances to different environments in a Multi-AZ configuration?", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "270399514", "PostHistoryTypeId": "3", "PostId": "72286019", "RevisionGUID": "fca6d1bb-169e-4580-a528-0706d6b9968e", "CreationDate": "2022-05-18T08:52:47.347", "UserId": "5294065", "Text": "|aws-cloudformation|amazon-rds|", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "270400280", "PostHistoryTypeId": "5", "PostId": "72286019", "RevisionGUID": "1889dea1-15de-4c6a-8ae5-a4aecc3f4de9", "CreationDate": "2022-05-18T09:02:12.687", "UserId": "5294065", "Comment": "added 62 characters in body", "Text": "I am trying to create Amazon RDS instances in different environments using CloudFormation templates. There is a Multi-AZ requirement in Prod, but other environments do not need Multi-AZ. This calls for a condition function in CloudFormation.\r\n\r\nBased on the [RDS CloudFormation docs][1] and using the [if condition in CloudFormation][2], the following should work in the template:\r\n\r\n```\r\nConditions:\r\n  IsProd: !Equals [ !Ref EnvironmentType, prod ]\r\n...\r\nResources:\r\n  MyRDSInstance:\r\n    Properties:\r\n      ...\r\n      AvailabilityZone:\r\n        !If [ IsProd, AWS::NoValue, af-south-1a ]\r\n      ...\r\n      MultiAZ: !If [ IsProd, true, false ]\r\n```\r\n\r\nWhen `IsProd` evaluates to:\r\n- false, `AvailabilityZone: af-south-1a` and `MultiAZ: false`\r\n- true, `AvailabilityZone` [is removed][3] and `MultiAZ: true`, which meets the requirement specified in the [docs][4]: \r\n>You can't set the AvailabilityZone parameter if the MultiAZ parameter is set to true.\r\n\r\nHowever, when trying to deploy the prod RDS instance, I still get the following error in CloudFormation when creating the stack, which then prevents the resources from being created at all:\r\n\r\n> Requesting a specific availability zone is not valid for Multi-AZ instances. (Service: AmazonRDS; Status Code: 400; Error Code: InvalidParameterCombination; Request ID: e6177fe4-4a4b-4db3-ba66-5f0e0f7218eb; Proxy: null)\r\n\r\nI suspect this is a bug in AWS due to a recent change that was applied in the source code, even though it was related to the CDK and not CloudFormation:\r\n- Issue: [Availability Zone parameter silently removed from stack when MultiAZ is true][5]\r\n- Fix committed on May 25, 2021: fix(rds): [Add exception throw when az is defined for multi-az db inst\u2026][6]. I am getting the error thrown in this exact fix.\r\n\r\nCould it be that CloudFormation is now not making provision for the `AWS::NoValue` pseudo parameter? If this is a bug in the source code, is there any way to get around this so I can still achieve Multi-AZ in the prod environment only?\r\n\r\n\r\n  [1]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-rds-database-instance.html\r\n  [2]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-conditions.html#intrinsic-function-reference-conditions-if\r\n  [3]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-conditions.html#:~:text=You%20can%20use%20the%20AWS%3A%3ANoValue%20pseudo%20parameter%20as%20a%20return%20value%20to%20remove%20the%20corresponding%20property.\r\n  [4]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-rds-database-instance.html#:~:text=You%20can%27t%20set%20the%20AvailabilityZone%20parameter%20if%20the%20MultiAZ%20parameter%20is%20set%20to%20true.\r\n  [5]: https://github.com/aws/aws-cdk/issues/10949\r\n  [6]: https://github.com/aws/aws-cdk/commit/fd8445ff1bf94b3dde26211c497bda7211b54dc0", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "However, when trying to deploy the prod RDS instance, I still get the following error in CloudFormation when creating the stack, which then prevents the resources from being created at all: ", "keywords": ["instance"]}, {"source": "Text", "text": "I suspect this is a bug in AWS due to a recent change that was applied in the source code, even though it was related to the CDK and not CloudFormation: - Issue: [Availability Zone parameter silently removed from stack when MultiAZ is true][5] - Fix committed on May 25, 2021: fix(rds): [Add exception throw when az is defined for multi-az db inst\u2026][6]. ", "keywords": ["change"]}, {"source": "Text", "text": "If this is a bug in the source code, is there any way to get around this so I can still achieve Multi-AZ in the prod environment only? [1]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-rds-database-instance.html [2]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-conditions.html#intrinsic-function-reference-conditions-if [3]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-conditions.html#:~:text=You%20can%20use%20the%20AWS%3A%3ANoValue%20pseudo%20parameter%20as%20a%20return%20value%20to%20remove%20the%20corresponding%20property. [4]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-rds-database-instance.html#:~:text=You%20can%27t%20set%20the%20AvailabilityZone%20parameter%20if%20the%20MultiAZ%20parameter%20is%20set%20to%20true. [5]: https://github.com/aws/aws-cdk/issues/10949 [6]: https://github.com/aws/aws-cdk/commit/fd8445ff1bf94b3dde26211c497bda7211b54dc0", "keywords": ["instance"]}]}], "answers": [{"Id": "72286730", "PostTypeId": "2", "ParentId": "72286019", "CreationDate": "2022-05-18T09:41:01.940", "Score": "1", "Body": "<p>So I tried to replicate the same at my end but in my case I was able to successfully create the RDS resource. I am attaching the template which I used for your reference.</p>\n<pre><code>AWSTemplateFormatVersion: 2010-09-09\nDescription: &gt;-\n  Description&quot;: &quot;AWS CloudFormation Sample Template for creating an Amazon RDS DB instance: \n  Sample template showing how to create a DB instance with Enhanced Monitoring enabled. \n  **WARNING** This template creates an RDS DB instance. You will be billed for the AWS \n  resources used if you create a stack from this template.\nParameters:\n  IsMultiAZ:\n    Type: String\n    Default: false\n    AllowedValues: [true,false]\n    Description: Please enter either &quot;true&quot; or &quot;false&quot;\n  DBInstanceID:\n    Default: mydbinstance\n    Description: My database instance\n    Type: String\n    MinLength: '1'\n    MaxLength: '63'\n    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'\n    ConstraintDescription: &gt;-\n      Must begin with a letter and must not end with a hyphen or contain two\n      consecutive hyphens.\n  DBName:\n    Default: mydb\n    Description: My database\n    Type: String\n    MinLength: '1'\n    MaxLength: '64'\n    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'\n    ConstraintDescription: Must begin with a letter and contain only alphanumeric characters.\n  DBInstanceClass:\n    Default: db.m5.large\n    Description: DB instance class\n    Type: String\n    ConstraintDescription: Must select a valid DB instance type.\n  DBAllocatedStorage:\n    Default: '50'\n    Description: The size of the database (GiB)\n    Type: Number\n    MinValue: '20'\n    MaxValue: '65536'\n    ConstraintDescription: must be between 20 and 65536 GiB.\n  DBUsername:\n    NoEcho: 'true'\n    Description: Username for MySQL database access\n    Type: String\n    MinLength: '1'\n    MaxLength: '16'\n    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'\n    ConstraintDescription: must begin with a letter and contain only alphanumeric characters.\n  DBPassword:\n    NoEcho: 'true'\n    Description: Password MySQL database access\n    Type: String\n    MinLength: '8'\n    MaxLength: '41'\n    AllowedPattern: '[a-zA-Z0-9]*'\n    ConstraintDescription: must contain only alphanumeric characters.\nConditions:\n  CheckIsMultiZone:\n     !Equals [!Ref IsMultiAZ, true]\n\nResources:\n  MyDB:\n    Type: 'AWS::RDS::DBInstance'\n    Properties:\n      DBInstanceIdentifier: !Ref DBInstanceID\n      DBName: !Ref DBName\n      DBInstanceClass: !Ref DBInstanceClass\n      AllocatedStorage: !Ref DBAllocatedStorage\n      Engine: MySQL\n      EngineVersion: &quot;8.0.16&quot;\n      MasterUsername: !Ref DBUsername\n      MasterUserPassword: !Ref DBPassword\n      MultiAZ: !Ref IsMultiAZ\n      AvailabilityZone: !If [CheckIsMultiZone, !Ref AWS::NoValue, &quot;us-east-1a&quot;]\n</code></pre>\n<p>As you can see I have used the same concept you used. Can you test this template at your end to see if this is working or not. One issue I found in your template is that you are using AWS::NoValue while the correct format is !Ref AWS::NoValue as shown in my template. I believe this is the issue in your case. You can check the example <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/pseudo-parameter-reference.html#cfn-pseudo-param-novalue\" rel=\"nofollow noreferrer\">here</a> .</p>\n", "OwnerUserId": "10014934", "LastEditorUserId": "10014934", "LastEditDate": "2022-05-18T09:47:08.533", "LastActivityDate": "2022-05-18T09:47:08.533", "CommentCount": "1", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "127709590", "PostId": "72286730", "Score": "0", "Text": "I did not try your template (and I'm sure it will work), but you pointed out the formatting error, which is the incorrect use of the pseudo parameter `AWS::NoValue`. I corrected it to `!Ref AWS::NoValue` and it worked. Thanks for the help! Turns out it was a much simpler problem than expected.", "CreationDate": "2022-05-18T10:35:55.387", "UserId": "5294065", "filtered-sentences": []}], "history": [{"Id": "270403188", "PostHistoryTypeId": "2", "PostId": "72286730", "RevisionGUID": "7955e69b-1f6e-4df9-bf7e-c30cb4c62be5", "CreationDate": "2022-05-18T09:41:01.940", "UserId": "10014934", "Text": "So I tried to replicate the same at my end but in my case I was able to successfully create the RDS resource. I am attaching the template which I used for your reference.\r\n\r\n    AWSTemplateFormatVersion: 2010-09-09\r\n    Description: >-\r\n      Description\": \"AWS CloudFormation Sample Template for creating an Amazon RDS DB instance: \r\n      Sample template showing how to create a DB instance with Enhanced Monitoring enabled. \r\n      **WARNING** This template creates an RDS DB instance. You will be billed for the AWS \r\n      resources used if you create a stack from this template.\r\n    Parameters:\r\n      IsMultiAZ:\r\n        Type: String\r\n        Default: false\r\n        AllowedValues: [true,false]\r\n        Description: Please enter either \"true\" or \"false\"\r\n      DBInstanceID:\r\n        Default: mydbinstance\r\n        Description: My database instance\r\n        Type: String\r\n        MinLength: '1'\r\n        MaxLength: '63'\r\n        AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'\r\n        ConstraintDescription: >-\r\n          Must begin with a letter and must not end with a hyphen or contain two\r\n          consecutive hyphens.\r\n      DBName:\r\n        Default: mydb\r\n        Description: My database\r\n        Type: String\r\n        MinLength: '1'\r\n        MaxLength: '64'\r\n        AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'\r\n        ConstraintDescription: Must begin with a letter and contain only alphanumeric characters.\r\n      DBInstanceClass:\r\n        Default: db.m5.large\r\n        Description: DB instance class\r\n        Type: String\r\n        ConstraintDescription: Must select a valid DB instance type.\r\n      DBAllocatedStorage:\r\n        Default: '50'\r\n        Description: The size of the database (GiB)\r\n        Type: Number\r\n        MinValue: '20'\r\n        MaxValue: '65536'\r\n        ConstraintDescription: must be between 20 and 65536 GiB.\r\n      DBUsername:\r\n        NoEcho: 'true'\r\n        Description: Username for MySQL database access\r\n        Type: String\r\n        MinLength: '1'\r\n        MaxLength: '16'\r\n        AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'\r\n        ConstraintDescription: must begin with a letter and contain only alphanumeric characters.\r\n      DBPassword:\r\n        NoEcho: 'true'\r\n        Description: Password MySQL database access\r\n        Type: String\r\n        MinLength: '8'\r\n        MaxLength: '41'\r\n        AllowedPattern: '[a-zA-Z0-9]*'\r\n        ConstraintDescription: must contain only alphanumeric characters.\r\n    Conditions:\r\n      CheckIsMultiZone:\r\n         !Equals [!Ref IsMultiAZ, true]\r\n    \r\n    Resources:\r\n      MyDB:\r\n        Type: 'AWS::RDS::DBInstance'\r\n        Properties:\r\n          DBInstanceIdentifier: !Ref DBInstanceID\r\n          DBName: !Ref DBName\r\n          DBInstanceClass: !Ref DBInstanceClass\r\n          AllocatedStorage: !Ref DBAllocatedStorage\r\n          Engine: MySQL\r\n          EngineVersion: \"8.0.16\"\r\n          MasterUsername: !Ref DBUsername\r\n          MasterUserPassword: !Ref DBPassword\r\n          MultiAZ: !Ref IsMultiAZ\r\n          AvailabilityZone: !If [CheckIsMultiZone, !Ref AWS::NoValue, \"us-east-1a\"]\r\n\r\nAs you can see I have used the same concept you used. Can you test this template at your end to see if this is working or not. One issue I found in your template is that you are using AWS::NoValue while the correct format is !Ref AWS::NoValue as shown in my template. I believe this is the issue in your case. You can check the example here [ https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/pseudo-parameter-reference.html#cfn-pseudo-param-novalue ].", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "AWSTemplateFormatVersion: 2010-09-09 Description: >- Description\": \"AWS CloudFormation Sample Template for creating an Amazon RDS DB instance: Sample template showing how to create a DB instance with Enhanced Monitoring enabled. ", "keywords": ["instance"]}, {"source": "Text", "text": "**WARNING** This template creates an RDS DB instance. ", "keywords": ["instance"]}, {"source": "Text", "text": "You will be billed for the AWS resources used if you create a stack from this template. ", "keywords": ["bill"]}, {"source": "Text", "text": "Parameters: IsMultiAZ: Type: String Default: false AllowedValues: [true,false] Description: Please enter either \"true\" or \"false\" DBInstanceID: Default: mydbinstance Description: My database instance Type: String MinLength: '1' MaxLength: '63' AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*' ConstraintDescription: >- Must begin with a letter and must not end with a hyphen or contain two consecutive hyphens. DBName: Default: mydb Description: My database Type: String MinLength: '1' MaxLength: '64' AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*' ConstraintDescription: Must begin with a letter and contain only alphanumeric characters. DBInstanceClass: Default: db.m5.large Description: DB instance class Type: String ConstraintDescription: Must select a valid DB instance type. DBAllocatedStorage: Default: '50' Description: The size of the database (GiB) Type: Number MinValue: '20' MaxValue: '65536' ConstraintDescription: must be between 20 and 65536 GiB. ", "keywords": ["instance"]}, {"source": "Text", "text": "Can you test this template at your end to see if this is working or not. ", "keywords": ["test"]}]}, {"Id": "270403657", "PostHistoryTypeId": "5", "PostId": "72286730", "RevisionGUID": "eb81a5a8-e3e0-48bf-84cb-c1bf460fc1ec", "CreationDate": "2022-05-18T09:47:08.533", "UserId": "10014934", "Comment": "added 14 characters in body", "Text": "So I tried to replicate the same at my end but in my case I was able to successfully create the RDS resource. I am attaching the template which I used for your reference.\r\n\r\n    AWSTemplateFormatVersion: 2010-09-09\r\n    Description: >-\r\n      Description\": \"AWS CloudFormation Sample Template for creating an Amazon RDS DB instance: \r\n      Sample template showing how to create a DB instance with Enhanced Monitoring enabled. \r\n      **WARNING** This template creates an RDS DB instance. You will be billed for the AWS \r\n      resources used if you create a stack from this template.\r\n    Parameters:\r\n      IsMultiAZ:\r\n        Type: String\r\n        Default: false\r\n        AllowedValues: [true,false]\r\n        Description: Please enter either \"true\" or \"false\"\r\n      DBInstanceID:\r\n        Default: mydbinstance\r\n        Description: My database instance\r\n        Type: String\r\n        MinLength: '1'\r\n        MaxLength: '63'\r\n        AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'\r\n        ConstraintDescription: >-\r\n          Must begin with a letter and must not end with a hyphen or contain two\r\n          consecutive hyphens.\r\n      DBName:\r\n        Default: mydb\r\n        Description: My database\r\n        Type: String\r\n        MinLength: '1'\r\n        MaxLength: '64'\r\n        AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'\r\n        ConstraintDescription: Must begin with a letter and contain only alphanumeric characters.\r\n      DBInstanceClass:\r\n        Default: db.m5.large\r\n        Description: DB instance class\r\n        Type: String\r\n        ConstraintDescription: Must select a valid DB instance type.\r\n      DBAllocatedStorage:\r\n        Default: '50'\r\n        Description: The size of the database (GiB)\r\n        Type: Number\r\n        MinValue: '20'\r\n        MaxValue: '65536'\r\n        ConstraintDescription: must be between 20 and 65536 GiB.\r\n      DBUsername:\r\n        NoEcho: 'true'\r\n        Description: Username for MySQL database access\r\n        Type: String\r\n        MinLength: '1'\r\n        MaxLength: '16'\r\n        AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'\r\n        ConstraintDescription: must begin with a letter and contain only alphanumeric characters.\r\n      DBPassword:\r\n        NoEcho: 'true'\r\n        Description: Password MySQL database access\r\n        Type: String\r\n        MinLength: '8'\r\n        MaxLength: '41'\r\n        AllowedPattern: '[a-zA-Z0-9]*'\r\n        ConstraintDescription: must contain only alphanumeric characters.\r\n    Conditions:\r\n      CheckIsMultiZone:\r\n         !Equals [!Ref IsMultiAZ, true]\r\n    \r\n    Resources:\r\n      MyDB:\r\n        Type: 'AWS::RDS::DBInstance'\r\n        Properties:\r\n          DBInstanceIdentifier: !Ref DBInstanceID\r\n          DBName: !Ref DBName\r\n          DBInstanceClass: !Ref DBInstanceClass\r\n          AllocatedStorage: !Ref DBAllocatedStorage\r\n          Engine: MySQL\r\n          EngineVersion: \"8.0.16\"\r\n          MasterUsername: !Ref DBUsername\r\n          MasterUserPassword: !Ref DBPassword\r\n          MultiAZ: !Ref IsMultiAZ\r\n          AvailabilityZone: !If [CheckIsMultiZone, !Ref AWS::NoValue, \"us-east-1a\"]\r\n\r\nAs you can see I have used the same concept you used. Can you test this template at your end to see if this is working or not. One issue I found in your template is that you are using AWS::NoValue while the correct format is !Ref AWS::NoValue as shown in my template. I believe this is the issue in your case. You can check the example [here][1] .\r\n\r\n\r\n  [1]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/pseudo-parameter-reference.html#cfn-pseudo-param-novalue", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "AWSTemplateFormatVersion: 2010-09-09 Description: >- Description\": \"AWS CloudFormation Sample Template for creating an Amazon RDS DB instance: Sample template showing how to create a DB instance with Enhanced Monitoring enabled. ", "keywords": ["instance"]}, {"source": "Text", "text": "**WARNING** This template creates an RDS DB instance. ", "keywords": ["instance"]}, {"source": "Text", "text": "You will be billed for the AWS resources used if you create a stack from this template. ", "keywords": ["bill"]}, {"source": "Text", "text": "Parameters: IsMultiAZ: Type: String Default: false AllowedValues: [true,false] Description: Please enter either \"true\" or \"false\" DBInstanceID: Default: mydbinstance Description: My database instance Type: String MinLength: '1' MaxLength: '63' AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*' ConstraintDescription: >- Must begin with a letter and must not end with a hyphen or contain two consecutive hyphens. DBName: Default: mydb Description: My database Type: String MinLength: '1' MaxLength: '64' AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*' ConstraintDescription: Must begin with a letter and contain only alphanumeric characters. DBInstanceClass: Default: db.m5.large Description: DB instance class Type: String ConstraintDescription: Must select a valid DB instance type. DBAllocatedStorage: Default: '50' Description: The size of the database (GiB) Type: Number MinValue: '20' MaxValue: '65536' ConstraintDescription: must be between 20 and 65536 GiB. ", "keywords": ["instance"]}, {"source": "Text", "text": "Can you test this template at your end to see if this is working or not. ", "keywords": ["test"]}]}], "filtered-sentences": [{"source": "Body", "text": "Can you test this template at your end to see if this is working or not. ", "keywords": ["test"]}]}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "However, when trying to deploy the prod RDS instance, I still get the following error in CloudFormation when creating the stack, which then prevents the resources from being created at all: Requesting a specific availability zone is not valid for Multi-AZ instances. ", "keywords": ["instance"]}, {"source": "Body", "text": "I suspect this is a bug in AWS due to a recent change that was applied in the source code, even though it was related to the CDK and not CloudFormation: Issue: Availability Zone parameter silently removed from stack when MultiAZ is true Fix committed on May 25, 2021: fix(rds): Add exception throw when az is defined for multi-az db inst\u2026. ", "keywords": ["change"]}]}