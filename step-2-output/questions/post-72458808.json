{"Id": "72458808", "PostTypeId": "1", "AcceptedAnswerId": "72477290", "CreationDate": "2022-06-01T08:41:31.827", "Score": "0", "ViewCount": "320", "Body": "<p>i have an amplify app with multiple branches.</p>\n<p>I have added an custom cloudformation template with <code>amplify add custom</code></p>\n<p>It looks like:</p>\n<pre><code>{\n  &quot;AWSTemplateFormatVersion&quot;: &quot;2010-09-09&quot;,\n  &quot;Parameters&quot;: { &quot;env&quot;: { &quot;Type&quot;: &quot;String&quot; } },\n  &quot;Resources&quot;: {\n    &quot;db&quot;: {\n      &quot;Type&quot;: &quot;AWS::Timestream::Database&quot;,\n      &quot;Properties&quot;: { &quot;DatabaseName&quot;: &quot;dev_db&quot; }\n    },\n    &quot;timestreamtable&quot;: {\n      &quot;DependsOn&quot;: &quot;db&quot;,\n      &quot;Type&quot;: &quot;AWS::Timestream::Table&quot;,\n      &quot;Properties&quot;: {\n        &quot;DatabaseName&quot;: &quot;dev_db&quot;,\n        &quot;TableName&quot;: &quot;avg_16_4h&quot;,\n        &quot;MagneticStoreWriteProperties&quot;: { &quot;EnableMagneticStoreWrites&quot;: true },\n        &quot;RetentionProperties&quot;: {\n          &quot;MemoryStoreRetentionPeriodInHours&quot;: &quot;8640&quot;,\n          &quot;MagneticStoreRetentionPeriodInDays&quot;: &quot;1825&quot;\n        }\n      }\n    }\n  },\n  &quot;Outputs&quot;: {},\n  &quot;Description&quot;: &quot;{\\&quot;createdOn\\&quot;:\\&quot;Windows\\&quot;,\\&quot;createdBy\\&quot;:\\&quot;Amplify\\&quot;,\\&quot;createdWith\\&quot;:\\&quot;8.3.1\\&quot;,\\&quot;stackType\\&quot;:\\&quot;custom-customCloudformation\\&quot;,\\&quot;metadata\\&quot;:{}}&quot;\n}\n</code></pre>\n<p>You can see there is a field called <code>DatabaseName</code>. In my amplify app i have written an env variable named <code>TIMESTREAM_DB</code> and i want to use it inside of this cloudformation file.</p>\n<p>Is this possible or do i need to write it all by hand in it?</p>\n", "OwnerUserId": "10990737", "LastActivityDate": "2022-06-02T13:44:54.067", "Title": "Use env variables inside cloudformation templates", "Tags": "|amazon-web-services|aws-cloudformation|aws-amplify|", "AnswerCount": "1", "CommentCount": "2", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "128006887", "PostId": "72458808", "Score": "0", "Text": "How does your Amplify app use the template? Is it calling the API to create a stack?", "CreationDate": "2022-06-01T12:02:56.250", "UserId": "13400729", "filtered-sentences": []}, {"Id": "128007707", "PostId": "72458808", "Score": "0", "Text": "@Parsifal i have 3 branches, whenever i push a branch it deploys an stack. The problem is that timestream is not an part of amplify so i need a custom clodformationtemplate. I want 3 different timestream databases for each branch 1 database. My idea was to save the db name as env variable inside of amplify and so it gets written inside the template when it gets pusehd", "CreationDate": "2022-06-01T12:37:57.443", "UserId": "10990737", "filtered-sentences": []}], "history": [{"Id": "271344371", "PostHistoryTypeId": "2", "PostId": "72458808", "RevisionGUID": "825645e6-7273-47ef-8b29-db293d25b97b", "CreationDate": "2022-06-01T08:41:31.827", "UserId": "10990737", "Text": "i have an amplify app with multiple branches. \r\n\r\nI have added an custom cloudformation template with `amplify add custom`\r\n\r\nIt looks like:\r\n\r\n    {\r\n      \"AWSTemplateFormatVersion\": \"2010-09-09\",\r\n      \"Parameters\": { \"env\": { \"Type\": \"String\" } },\r\n      \"Resources\": {\r\n        \"db\": {\r\n          \"Type\": \"AWS::Timestream::Database\",\r\n          \"Properties\": { \"DatabaseName\": \"dev_db\" }\r\n        },\r\n        \"timestreamtable\": {\r\n          \"DependsOn\": \"db\",\r\n          \"Type\": \"AWS::Timestream::Table\",\r\n          \"Properties\": {\r\n            \"DatabaseName\": \"dev_db\",\r\n            \"TableName\": \"avg_16_4h\",\r\n            \"MagneticStoreWriteProperties\": { \"EnableMagneticStoreWrites\": true },\r\n            \"RetentionProperties\": {\r\n              \"MemoryStoreRetentionPeriodInHours\": \"8640\",\r\n              \"MagneticStoreRetentionPeriodInDays\": \"1825\"\r\n            }\r\n          }\r\n        }\r\n      },\r\n      \"Outputs\": {},\r\n      \"Description\": \"{\\\"createdOn\\\":\\\"Windows\\\",\\\"createdBy\\\":\\\"Amplify\\\",\\\"createdWith\\\":\\\"8.3.1\\\",\\\"stackType\\\":\\\"custom-customCloudformation\\\",\\\"metadata\\\":{}}\"\r\n    }\r\n\r\nYou can see there is a field called `DatabaseName`. In my amplify app i have written an env variable named `TIMESTREAM_DB` and i want to use it inside of this cloudformation file.\r\n\r\nIs this possible or do i need to write it all by hand in it?\r\n\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "271344373", "PostHistoryTypeId": "1", "PostId": "72458808", "RevisionGUID": "825645e6-7273-47ef-8b29-db293d25b97b", "CreationDate": "2022-06-01T08:41:31.827", "UserId": "10990737", "Text": "Use env variables inside cloudformation templates", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "271344374", "PostHistoryTypeId": "3", "PostId": "72458808", "RevisionGUID": "825645e6-7273-47ef-8b29-db293d25b97b", "CreationDate": "2022-06-01T08:41:31.827", "UserId": "10990737", "Text": "|amazon-web-services|aws-cloudformation|aws-amplify|", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "72477290", "PostTypeId": "2", "ParentId": "72458808", "CreationDate": "2022-06-02T13:44:54.067", "Score": "1", "Body": "<p>Templates cannot access arbitrary env vars. Instead, CloudFormation injects deploy-time values into a template with <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html\" rel=\"nofollow noreferrer\">Parameters</a>.</p>\n<p>Amplify helpfully adds the <code>env</code> variable as a parameter.  A la the <a href=\"https://docs.amplify.aws/cli/custom/cloudformation/\" rel=\"nofollow noreferrer\">Amplify docs</a>, use the <code>env</code> value as the <code>AWS::Timestream::Database</code> name suffix:</p>\n<pre class=\"lang-json prettyprint-override\"><code>&quot;DatabaseName&quot;: &quot;Fn::Join&quot;: [ &quot;&quot;, [ &quot;my-timestream-db-name-&quot;, { &quot;Ref&quot;: &quot;env&quot; } ] ]\n</code></pre>\n<p>The <code>AWS::Timestream::Table</code> resource also requires a <code>DatabaseName</code> parameter.  You could repeat the above, but it's more DRY to get the name <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-timestream-database.html#aws-resource-timestream-database-return-values\" rel=\"nofollow noreferrer\">via the Database's Ref</a>:</p>\n<pre class=\"lang-json prettyprint-override\"><code>&quot;DatabaseName&quot;: { &quot;Ref&quot; : &quot;db&quot; }\n</code></pre>\n", "OwnerUserId": "1103511", "LastActivityDate": "2022-06-02T13:44:54.067", "CommentCount": "2", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "128050143", "PostId": "72477290", "Score": "0", "Text": "When i change the name the old timestream DB gets erased with all of its data and a new one gets created. Is it possible to keep the data in the renaming process? Is there some documentation about this?", "CreationDate": "2022-06-03T08:55:20.420", "UserId": "10990737", "filtered-sentences": [{"source": "Text", "text": "When i change the name the old timestream DB gets erased with all of its data and a new one gets created. ", "keywords": ["change"]}]}, {"Id": "128050438", "PostId": "72477290", "Score": "0", "Text": "@bill.gates Changing a CloudFormation resource's name always results in [replacement behaviour](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-update-behaviors.html).  The old resource gets deleted.  Some storage resources have a [DeletionPolicy](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-deletionpolicy.html) attribute to retain the old resource outside the stack.  I don't know if the Timestream resources have this attribute.", "CreationDate": "2022-06-03T09:10:01.130", "UserId": "1103511", "filtered-sentences": [{"source": "Text", "text": "@bill.gates Changing a CloudFormation resource's name always results in [replacement behaviour](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-update-behaviors.html). ", "keywords": ["bill", "change"]}, {"source": "Text", "text": "Some storage resources have a [DeletionPolicy](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-deletionpolicy.html) attribute to retain the old resource outside the stack. ", "keywords": ["storage"]}]}], "history": [{"Id": "271441845", "PostHistoryTypeId": "2", "PostId": "72477290", "RevisionGUID": "b98be06e-d889-4621-8bd5-2f1ef7e67228", "CreationDate": "2022-06-02T13:44:54.067", "UserId": "1103511", "Text": "Templates cannot access arbitrary env vars. Instead, CloudFormation injects deploy-time values into a template with [Parameters](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html).\r\n\r\nAmplify helpfully adds the `env` variable as a parameter.  A la the [Amplify docs](https://docs.amplify.aws/cli/custom/cloudformation/), use the `env` value as the `AWS::Timestream::Database` name suffix:\r\n\r\n```json\r\n\"DatabaseName\": \"Fn::Join\": [ \"\", [ \"my-timestream-db-name-\", { \"Ref\": \"env\" } ] ]\r\n```\r\n\r\nThe `AWS::Timestream::Table` resource also requires a `DatabaseName` parameter.  You could repeat the above, but it's more DRY to get the name [via the Database's Ref](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-timestream-database.html#aws-resource-timestream-database-return-values): \r\n\r\n```json\r\n\"DatabaseName\": { \"Ref\" : \"db\" }\r\n```", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": []}