{"Id": "77352298", "PostTypeId": "1", "CreationDate": "2023-10-24T13:03:48.007", "Score": "1", "ViewCount": "128", "Body": "<p>In AWS, I have a CloudFormation stack that I would like to delete and redeploy from scratch. The stack comprises S3 buckets that are part of it i.e. not imported.</p>\n<p>I would like to preserve the S3 buckets during deletion, and reattach those to the stack when it is deployed again.</p>\n<p>The buckets retention policy does the job for the first part. But I am not able to force SAM / CloudFormation to use the existing buckets instead of creating new ones when redeploying the stack. The deployment fails because the bucket with the same name already exists, which is expected. Is there a solution to achieve this?</p>\n<p>I can also rename the old buckets, deploy again, then move all the files from the old buckets to the new ones. In addition to the time lost because there are a lot of big files, there is additional billing involved for the corresponding I/O. Hence, I would greatly prefer a solution to directly reattach the &quot;old&quot; buckets.</p>\n<p>Changing the SAM template to import the buckets is not feasible either. The whole thing should be reproducible on different environments in an automated manner as part of a CI/CD pipeline.</p>\n<p>The reason of this operation is to work around an issue with a SAM deployment that supposedly exceeds the maximum size in some Lambda functions when deployed as an incremental update, although it deploys correctly from scratch.</p>\n", "OwnerUserId": "460426", "LastEditorUserId": "3390419", "LastEditDate": "2023-10-24T15:11:49.653", "LastActivityDate": "2023-10-24T15:11:49.653", "Title": "How to delete and redeploy a CloudFormation stack, while preserving S3 buckets?", "Tags": "|amazon-web-services|amazon-s3|aws-cloudformation|aws-sam|", "AnswerCount": "0", "CommentCount": "1", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "136366697", "PostId": "77352298", "Score": "0", "Text": "You need to do something similar to this https://stackoverflow.com/questions/77159055/how-to-switch-elastic-ip-from-one-ec2-instance-to-another-using-cloudformation/77211120#77211120", "CreationDate": "2023-10-24T13:09:26.550", "UserId": "3390419", "filtered-sentences": [{"source": "Text", "text": "You need to do something similar to this https://stackoverflow.com/questions/77159055/how-to-switch-elastic-ip-from-one-ec2-instance-to-another-using-cloudformation/77211120#77211120", "keywords": ["instance"]}]}], "history": [{"Id": "299357012", "PostHistoryTypeId": "2", "PostId": "77352298", "RevisionGUID": "e83c5dbd-a4c3-45b2-96f9-f4c4a36404b3", "CreationDate": "2023-10-24T13:03:48.007", "UserId": "460426", "Text": "In AWS, I have a CloudFormation stack that I would like to delete and redeploy from scratch. The stack comprises S3 buckets that are part of it i.e. not imported.\r\n\r\nI would like to preserve the S3 buckets during deletion, and reattach those to the stack when it is deployed again.\r\n\r\nThe buckets retention policy does the job for the first part. But I am not able to force SAM / CloudFormation to use the existing buckets instead of creating new ones when redeploying the stack. The deployment fails because the bucket with the same name already exists, which is expected. Is there a solution to achieve this?\r\n\r\nI can also rename the old buckets, deploy again, then move all the files from the old buckets to the new ones. In addition to the time lost because there are a lot of big files, there is additional billing involved for the corresponding I/O. Hence, I would greatly prefer a solution to directly reattach the \"old\" buckets.\r\n\r\nChanging the SAM template to import the buckets is not feasible either. The whole thing should be reproducible on different environments in an automated manner as part of a CI/CD pipeline.\r\n\r\nThe reason of this operation is to work around an issue with a SAM deployment that supposedly exceeds the maximum size in some Lambda functions when deployed as an incremental update, although it deploys correctly from scratch.", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "The buckets retention policy does the job for the first part. ", "keywords": ["policy"]}, {"source": "Text", "text": "In addition to the time lost because there are a lot of big files, there is additional billing involved for the corresponding I/O. ", "keywords": ["bill"]}, {"source": "Text", "text": "Changing the SAM template to import the buckets is not feasible either. ", "keywords": ["change"]}]}, {"Id": "299357014", "PostHistoryTypeId": "1", "PostId": "77352298", "RevisionGUID": "e83c5dbd-a4c3-45b2-96f9-f4c4a36404b3", "CreationDate": "2023-10-24T13:03:48.007", "UserId": "460426", "Text": "How to delete and redeploy a CloundFormation stack, while preserving S3 buckets?", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "299357015", "PostHistoryTypeId": "3", "PostId": "77352298", "RevisionGUID": "e83c5dbd-a4c3-45b2-96f9-f4c4a36404b3", "CreationDate": "2023-10-24T13:03:48.007", "UserId": "460426", "Text": "|amazon-web-services|amazon-s3|aws-cloudformation|aws-sam|", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "299362684", "PostHistoryTypeId": "4", "PostId": "77352298", "RevisionGUID": "235b3ea6-05ff-4356-b83d-d61bf3692fc7", "CreationDate": "2023-10-24T15:11:49.653", "UserId": "3390419", "Comment": "edited title", "Text": "How to delete and redeploy a CloudFormation stack, while preserving S3 buckets?", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "The buckets retention policy does the job for the first part. ", "keywords": ["policy"]}, {"source": "Body", "text": "In addition to the time lost because there are a lot of big files, there is additional billing involved for the corresponding I/O. ", "keywords": ["bill"]}, {"source": "Body", "text": "Changing the SAM template to import the buckets is not feasible either. ", "keywords": ["change"]}]}