{"Id": "53422296", "PostTypeId": "1", "AcceptedAnswerId": "53477868", "CreationDate": "2018-11-22T00:27:28.443", "Score": "45", "ViewCount": "48221", "Body": "<p>Quick question: Is it possible to trigger the execution of a Step Function after an SQS message was sent?, if so, how would you specify it into the cloudformation yaml file?</p>\n\n<p>Thanks in advance.</p>\n", "OwnerUserId": "7053852", "LastActivityDate": "2023-06-14T19:59:32.370", "Title": "AWS SQS trigger Step Functions", "Tags": "|amazon-web-services|python-3.6|aws-cloudformation|amazon-sqs|aws-step-functions|", "AnswerCount": "2", "CommentCount": "0", "FavoriteCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "186322829", "PostHistoryTypeId": "2", "PostId": "53422296", "RevisionGUID": "be9d0aac-0286-4e08-a96d-4fecac69e761", "CreationDate": "2018-11-22T00:27:28.443", "UserId": "7053852", "Text": "Quick question: Is it possible to trigger the execution of a Step Function after an SQS message was sent?, if so, how would you specify it into the cloudformation yaml file?\r\n\r\nThanks in advance.", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "186322830", "PostHistoryTypeId": "1", "PostId": "53422296", "RevisionGUID": "be9d0aac-0286-4e08-a96d-4fecac69e761", "CreationDate": "2018-11-22T00:27:28.443", "UserId": "7053852", "Text": "AWS SQS trigger Step Functions", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "186322831", "PostHistoryTypeId": "3", "PostId": "53422296", "RevisionGUID": "be9d0aac-0286-4e08-a96d-4fecac69e761", "CreationDate": "2018-11-22T00:27:28.443", "UserId": "7053852", "Text": "|amazon-web-services|python-3.6|aws-cloudformation|amazon-sqs|aws-step-functions|", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "74757006", "PostTypeId": "2", "ParentId": "53422296", "CreationDate": "2022-12-10T22:32:36.623", "Score": "23", "Body": "<p>EventBridge Pipes (launched at re:Invent 2022) allows you to trigger Step Functions State Machines without need for a Lambda function.</p>\n<p><a href=\"https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-pipes.html\" rel=\"noreferrer\">https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-pipes.html</a></p>\n<p>You can find an example here:</p>\n<p><a href=\"https://github.com/aws-samples/aws-stepfunctions-examples/blob/main/sam/demo-trigger-stepfunctions-from-sqs/template.yaml\" rel=\"noreferrer\">https://github.com/aws-samples/aws-stepfunctions-examples/blob/main/sam/demo-trigger-stepfunctions-from-sqs/template.yaml</a></p>\n", "OwnerUserId": "20586135", "LastActivityDate": "2022-12-10T22:32:36.623", "CommentCount": "3", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "132610985", "PostId": "74757006", "Score": "0", "Text": "This is the way to go nowadays.  I was concerned that it might be expensive, but I checked [pricing](https://aws.amazon.com/eventbridge/pricing/#:~:text=5.00%20per%20month-,Pipes,-Amazon%20EventBridge%20Pipes) and it's not expensive at all.  I'd be surprised if it cost any more than using Lambda in the middle.", "CreationDate": "2023-01-17T14:34:12.787", "UserId": "5354201", "filtered-sentences": [{"source": "Text", "text": "I was concerned that it might be expensive, but I checked [pricing](https://aws.amazon.com/eventbridge/pricing/#:~:text=5.00%20per%20month-,Pipes,-Amazon%20EventBridge%20Pipes) and it's not expensive at all. ", "keywords": ["expense"]}, {"source": "Text", "text": "I'd be surprised if it cost any more than using Lambda in the middle.", "keywords": ["cost"]}]}, {"Id": "132634549", "PostId": "74757006", "Score": "3", "Text": "For anyone looking for an CDK implementation; https://github.com/aws/aws-cdk-rfcs/issues/473 it's still on progress.", "CreationDate": "2023-01-18T15:52:43.483", "UserId": "4166285", "filtered-sentences": []}, {"Id": "133062059", "PostId": "74757006", "Score": "0", "Text": "In addition to @Capan comment, there is still an L1 construct you can use. https://docs.aws.amazon.com/cdk/api/v1/docs/aws-pipes-readme.html", "CreationDate": "2023-02-10T14:01:07.617", "UserId": "6586516", "filtered-sentences": []}], "history": [{"Id": "284037373", "PostHistoryTypeId": "2", "PostId": "74757006", "RevisionGUID": "44d36486-662b-4071-9e05-7228c4bf825a", "CreationDate": "2022-12-10T22:32:36.623", "UserId": "20586135", "Text": "EventBridge Pipes (launched at re:Invent 2022) allows you to trigger Step Functions State Machines without need for a Lambda function. \r\n\r\nhttps://docs.aws.amazon.com/eventbridge/latest/userguide/eb-pipes.html\r\n\r\nYou can find an example here:\r\n\r\nhttps://github.com/aws-samples/aws-stepfunctions-examples/blob/main/sam/demo-trigger-stepfunctions-from-sqs/template.yaml ", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "284037375", "PostHistoryTypeId": "33", "PostId": "74757006", "RevisionGUID": "23d92213-c9ec-4406-9439-a43364e2dfad", "CreationDate": "2022-12-10T22:32:36.623", "UserId": "-1011", "Comment": "297916", "filtered-sentences": []}], "filtered-sentences": []}, {"Id": "53477868", "PostTypeId": "2", "ParentId": "53422296", "CreationDate": "2018-11-26T09:15:01.083", "Score": "67", "Body": "<p>The first think to consider is this: do you <em>really</em> need to use SQS to start a Step Functions state machine? Can you <a href=\"https://docs.aws.amazon.com/step-functions/latest/dg/tutorial-api-gateway.html\" rel=\"noreferrer\">use API gateway</a> instead? Or could you write your messages to a S3 bucket and <a href=\"https://docs.aws.amazon.com/step-functions/latest/dg/tutorial-cloudwatch-events-s3.html\" rel=\"noreferrer\">use the CloudWatch events to start a state machine</a>?</p>\n\n<p>If you must use SQS, then you will need to have a lambda function to act as a proxy. You will need to <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/with-sqs.html\" rel=\"noreferrer\">set up the queue as a lambda trigger</a>, and you will need to write a lambda that can parse the SQS message and make the appropriate call to the Step Functions <a href=\"https://docs.aws.amazon.com/step-functions/latest/apireference/API_StartExecution.html\" rel=\"noreferrer\">StartExecution API</a>. </p>\n\n<p>I\u2019m on mobile, so I can\u2019t type up the yaml right now, but if you need it, I can try to update with it later. For now, here is detailed walkthrough of how to <a href=\"https://medium.com/@mebnoah/invoke-aws-step-function-from-aws-lambda-using-the-serverless-framework-21b7fde38a42\" rel=\"noreferrer\">invoke a Step Functions state machine from Lambda</a> (including example yaml), and here is walkthrough of how to <a href=\"https://www.itonaut.com/2018/07/11/sqs-queue-as-lambda-trigger-in-aws-cloudformation/\" rel=\"noreferrer\">use CloudFormation to set up SQS to trigger a Lambda</a>. </p>\n", "OwnerUserId": "5563569", "LastActivityDate": "2018-11-26T09:15:01.083", "CommentCount": "9", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "100900609", "PostId": "53477868", "Score": "0", "Text": "This was the best approach. Thanks a lot.", "CreationDate": "2019-07-25T06:58:49.230", "UserId": "7053852", "filtered-sentences": []}, {"Id": "101049569", "PostId": "53477868", "Score": "4", "Text": "With this approach, how you can handle errors on step functions? Because, when the message is received in the lambda function, the message will be deleted from SQS. And if an error is raised on Step Function, neither SQS nor Lambda Function will be notified. I am assuiming that in the most cases errors will appears on step function and not in the lambda that call it", "CreationDate": "2019-07-30T16:11:09.790", "UserId": "4216714", "filtered-sentences": []}, {"Id": "101049780", "PostId": "53477868", "Score": "2", "Text": "The SQS message is not deleted until the message is successfully processed (ie. Step Function started) by the Lambda Function. Inside your Step Function, you would use the same approach for error handling as in any other Step Function. https://docs.aws.amazon.com/step-functions/latest/dg/concepts-error-handling.html", "CreationDate": "2019-07-30T16:17:34.180", "UserId": "5563569", "filtered-sentences": []}, {"Id": "119936293", "PostId": "53477868", "Score": "0", "Text": "Is there a different way if the Step function is long running (say 30-90 mins) and the integration should be synchronous. i.e. SQS message must be deleted only after SFN completes. Wish SQS provides direct sync integration with SFN without the lambda as lambda cannot run for more than 15 mins.", "CreationDate": "2021-06-06T03:18:55.427", "UserId": "8788071", "filtered-sentences": []}, {"Id": "120322051", "PostId": "53477868", "Score": "0", "Text": "@NaveenKumar deleting the message after a long step function completes sounds like an anti pattern because SQS is a queuing mechanism, not a state tracker. I think you may want to ask a new question, and beware of the XY problem when you do.", "CreationDate": "2021-06-22T01:24:13.900", "UserId": "5563569", "filtered-sentences": []}, {"Id": "120793371", "PostId": "53477868", "Score": "1", "Text": "@MatthewPope, why would it be an anti-pattern? Looks like a reasonable approach if you want the Step Function to acknowledge/retry the message in case of success/failure, in the same way a Lambda would do. In many cases, retrying individual steps in the SFN may be enough, but I can imagine some other cases where you would want to retry the entire SFN.", "CreationDate": "2021-07-12T12:54:55.987", "UserId": "1967100", "filtered-sentences": []}, {"Id": "120973361", "PostId": "53477868", "Score": "1", "Text": "Looking at the first question in this answer - do I really need SQS to start  a step function, I wonder if rate limiting is a good reason, say you want to limit the number of concurrent sfn executions, e.g. a scraper that avoids bombarding the website, ... etc. Would be great to have some criteria to consider.", "CreationDate": "2021-07-20T06:47:03.340", "UserId": "9814131", "filtered-sentences": []}, {"Id": "126860415", "PostId": "53477868", "Score": "2", "Text": "If your step function completes in reasobably fast times (<5 minutes) you can use an express step function as illustrated here: https://docs.aws.amazon.com/step-functions/latest/dg/sample-project-express-high-volume-sqs.html\n\nWith this approach your jobs will be deleted from the queue only if the step function succeeds.\n\nMake sure to increase SQS VisibilityTimeout if the step function lasts more than 30secs: https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-visibility-timeout.html . This will help you to avoid triggering the same execution over and over", "CreationDate": "2022-04-07T17:42:13.583", "UserId": "495177", "filtered-sentences": []}, {"Id": "127257164", "PostId": "53477868", "Score": "1", "Text": "@MatthewPope The message is deleted from the queue __only when explicitly deleted__ from the queue.  I only comment here because your comment sounded as if successful completion of the lambda automagically deletes the message. When you are done processing the message, you must explicitly delete it otherwise it becomes visible on the queue again.\nWhen a message is retrieved from queue it is only _hidden_ from anybody reading more messages from the queue. It is visible again if the value set for its visibility timeout is reached before it is deleted from queue.", "CreationDate": "2022-04-26T19:59:49.343", "UserId": "5034159", "filtered-sentences": []}], "history": [{"Id": "186560313", "PostHistoryTypeId": "2", "PostId": "53477868", "RevisionGUID": "eee32c06-bdc4-4302-a5c0-7a9d575814cc", "CreationDate": "2018-11-26T09:15:01.083", "UserId": "5563569", "Text": "The first think to consider is this: do you *really* need to use SQS to start a Step Functions state machine? Can you [use API gateway][1] instead? Or could you write your messages to a S3 bucket and [use the CloudWatch events to start a state machine][2]?\n\nIf you must use SQS, then you will need to have a lambda function to act as a proxy. You will need to [set up the queue as a lambda trigger][3], and you will need to write a lambda that can parse the SQS message and make the appropriate call to the Step Functions [StartExecution API][4]. \n\nI\u2019m on mobile, so I can\u2019t type up the yaml right now, but if you need it, I can try to update with it later. For now, here is detailed walkthrough of how to [invoke a Step Functions state machine from Lambda][5] (including example yaml), and here is walkthrough of how to [use CloudFormation to set up SQS to trigger a Lambda][6]. \n\n\n  [1]: https://docs.aws.amazon.com/step-functions/latest/dg/tutorial-api-gateway.html\n  [2]: https://docs.aws.amazon.com/step-functions/latest/dg/tutorial-cloudwatch-events-s3.html\n  [3]: https://docs.aws.amazon.com/lambda/latest/dg/with-sqs.html\n  [4]: https://docs.aws.amazon.com/step-functions/latest/apireference/API_StartExecution.html\n  [5]: https://medium.com/@mebnoah/invoke-aws-step-function-from-aws-lambda-using-the-serverless-framework-21b7fde38a42\n  [6]: https://www.itonaut.com/2018/07/11/sqs-queue-as-lambda-trigger-in-aws-cloudformation/", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": false, "filtered-sentences": []}