{"Id": "75308105", "PostTypeId": "1", "CreationDate": "2023-02-01T09:33:19.033", "Score": "0", "ViewCount": "184", "Body": "<p>I would like to use jinja logic in my template:</p>\n<pre><code>---\nAWSTemplateFormatVersion: 2010-09-09\nDescription: '{{ git_repository.after | truncate(8, end='') }} @ infra-lambda.git : roles/{{ lambda_name }}'\n\nResources:\n\n{% if lambda_account == 'true' %}\n  RoleToAssume:\n    Type: AWS::IAM::Role\n    Properties:\n      RoleName: &quot;infra-lambda-{{ lambda_name }}-LambdaRole-{{ shortname }}-{{ dtap }}&quot;\n      AssumeRolePolicyDocument:\n        Version: &quot;2012-10-17&quot;\n        Statement:\n          - Effect: &quot;Allow&quot;\n            Principal:\n              Service:\n                - &quot;lambda.amazonaws.com&quot;\n            Action:\n              - &quot;sts:AssumeRole&quot;\n      Path: &quot;/&quot;\n      ManagedPolicyArns:\n        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole\n      Policies:\n        - PolicyName: RoleToAssumeLambdaPolicy\n          PolicyDocument:\n            Version: 2012-10-17\n            Statement:\n              - Effect: Allow\n                Action:\n                  - logs:CreateLogGroup\n                  - logs:CreateLogStream\n                  - logs:PutLogEvents\n                Resource: arn:aws:logs:*:*:*\n              - Effect: Allow\n                Action:\n                  - &quot;cloudwatch:Get*&quot;\n                  - &quot;cloudwatch:List*&quot;\n                  - &quot;cloudwatch:Put*&quot;\n                Resource:\n                  - &quot;*&quot;\n              - Effect: Allow\n                Action:\n                  - &quot;sts:AssumeRole&quot;\n                Resource:\n                  - &quot;*&quot;\n\n{% else %}\n  RoleToBeAssumed:\n    Type: AWS::IAM::Role\n    Properties:\n      RoleName: RoleToBeAssumed\n      AssumeRolePolicyDocument:\n        Version: &quot;2012-10-17&quot;\n        Statement:\n          - Sid: DefaultStatement\n            Effect: &quot;Allow&quot;\n            Principal:\n              AWS:\n                - &quot;arn:aws:iam::{AWS_ACCOUNT}:role/lambda_assume&quot;\n            Action:\n              - &quot;sts:AssumeRole&quot;\n      Path: &quot;/&quot;\n      Policies:\n        - PolicyName: &quot;DeleteCertificates&quot;\n          PolicyDocument:\n            Version: &quot;2012-10-17&quot;\n            Statement:\n              - Effect: &quot;Allow&quot;\n                Action:\n                  - acm:DeleteCertificate\n                  - acm:GetCertificate\n                Action:\n                  - acm:ListCertificates\n                Resource: '*'\n{% endif %}\n</code></pre>\n<p>I've already tried true without '' and instead of true is defined but still no success. The logic is pretty simple. In the inventory I have:</p>\n<pre><code>unused_certs:\n  enabled: true\n  lambda_account: true\n</code></pre>\n<p>If I have the above in the inventory only RoleToAssume and LambdaFunction resources should be created. If I don\u2019t have lambda_account set to true, only the resources after the else statement should be created. Any idea why only the resources after the else statement are being created by CloudFormation? I cannot use &quot;when&quot; in Ansible playbook because my repo is not constructed that way unfortunately.</p>\n", "OwnerUserId": "13450573", "LastActivityDate": "2023-02-01T11:19:06.083", "Title": "How to use jinja if-else logic together with Ansible inventory", "Tags": "|templates|ansible|yaml|jinja2|aws-cloudformation|", "AnswerCount": "1", "CommentCount": "2", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "132886263", "PostId": "75308105", "Score": "0", "Text": "How are you passing `unused_certs` to the template?", "CreationDate": "2023-02-01T10:50:41.817", "UserId": "1029453", "filtered-sentences": []}, {"Id": "132892258", "PostId": "75308105", "Score": "0", "Text": "What is the error you're having or what is the behavior you get and how does it differ from the one you expect? Please see [ask] and pay attention to the [mre] section.", "CreationDate": "2023-02-01T15:45:11.513", "UserId": "9401096", "filtered-sentences": [{"source": "Text", "text": "Please see [ask] and pay attention to the [mre] section.", "keywords": ["pay"]}]}], "history": [{"Id": "287231600", "PostHistoryTypeId": "2", "PostId": "75308105", "RevisionGUID": "fad45ed0-ab94-4849-90d3-799037a745ec", "CreationDate": "2023-02-01T09:33:19.033", "UserId": "13450573", "Text": "I would like to use jinja logic in my template:\r\n```\r\n---\r\nAWSTemplateFormatVersion: 2010-09-09\r\nDescription: '{{ git_repository.after | truncate(8, end='') }} @ infra-lambda.git : roles/{{ lambda_name }}'\r\n\r\nResources:\r\n\r\n{% if lambda_account == 'true' %}\r\n  RoleToAssume:\r\n    Type: AWS::IAM::Role\r\n    Properties:\r\n      RoleName: \"infra-lambda-{{ lambda_name }}-LambdaRole-{{ shortname }}-{{ dtap }}\"\r\n      AssumeRolePolicyDocument:\r\n        Version: \"2012-10-17\"\r\n        Statement:\r\n          - Effect: \"Allow\"\r\n            Principal:\r\n              Service:\r\n                - \"lambda.amazonaws.com\"\r\n            Action:\r\n              - \"sts:AssumeRole\"\r\n      Path: \"/\"\r\n      ManagedPolicyArns:\r\n        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole\r\n      Policies:\r\n        - PolicyName: RoleToAssumeLambdaPolicy\r\n          PolicyDocument:\r\n            Version: 2012-10-17\r\n            Statement:\r\n              - Effect: Allow\r\n                Action:\r\n                  - logs:CreateLogGroup\r\n                  - logs:CreateLogStream\r\n                  - logs:PutLogEvents\r\n                Resource: arn:aws:logs:*:*:*\r\n              - Effect: Allow\r\n                Action:\r\n                  - \"cloudwatch:Get*\"\r\n                  - \"cloudwatch:List*\"\r\n                  - \"cloudwatch:Put*\"\r\n                Resource:\r\n                  - \"*\"\r\n              - Effect: Allow\r\n                Action:\r\n                  - \"sts:AssumeRole\"\r\n                Resource:\r\n                  - \"*\"\r\n\r\n{% else %}\r\n  RoleToBeAssumed:\r\n    Type: AWS::IAM::Role\r\n    Properties:\r\n      RoleName: RoleToBeAssumed\r\n      AssumeRolePolicyDocument:\r\n        Version: \"2012-10-17\"\r\n        Statement:\r\n          - Sid: DefaultStatement\r\n            Effect: \"Allow\"\r\n            Principal:\r\n              AWS:\r\n                - \"arn:aws:iam::{AWS_ACCOUNT}:role/lambda_assume\"\r\n            Action:\r\n              - \"sts:AssumeRole\"\r\n      Path: \"/\"\r\n      Policies:\r\n        - PolicyName: \"DeleteCertificates\"\r\n          PolicyDocument:\r\n            Version: \"2012-10-17\"\r\n            Statement:\r\n              - Effect: \"Allow\"\r\n                Action:\r\n                  - acm:DeleteCertificate\r\n                  - acm:GetCertificate\r\n                Action:\r\n                  - acm:ListCertificates\r\n                Resource: '*'\r\n{% endif %}\r\n```\r\nI've already tried true without '' and instead of true is defined but still no success. The logic is pretty simple. In the inventory I have:\r\n```\r\nunused_certs:\r\n  enabled: true\r\n  lambda_account: true\r\n```\r\nIf I have the above in the inventory only RoleToAssume and LambdaFunction resources should be created. If I don\u2019t have lambda_account set to true, only the resources after the else statement should be created. Any idea why only the resources after the else statement are being created by CloudFormation? I cannot use \"when\" in Ansible playbook because my repo is not constructed that way unfortunately. ", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "I would like to use jinja logic in my template: ``` --- AWSTemplateFormatVersion: 2010-09-09 Description: '{{ git_repository.after | truncate(8, end='') }} @ infra-lambda.git : roles/{{ lambda_name }}' Resources: {% if lambda_account == 'true' %} RoleToAssume: Type: AWS::IAM::Role Properties: RoleName: \"infra-lambda-{{ lambda_name }}-LambdaRole-{{ shortname }}-{{ dtap }}\" AssumeRolePolicyDocument: Version: \"2012-10-17\" Statement: - Effect: \"Allow\" Principal: Service: - \"lambda.amazonaws.com\" Action: - \"sts:AssumeRole\" Path: \"/\" ManagedPolicyArns: - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole Policies: - PolicyName: RoleToAssumeLambdaPolicy PolicyDocument: Version: 2012-10-17 Statement: - Effect: Allow Action: - logs:CreateLogGroup - logs:CreateLogStream - logs:PutLogEvents Resource: arn:aws:logs:*:*:* - Effect: Allow Action: - \"cloudwatch:Get*\" - \"cloudwatch:List*\" - \"cloudwatch:Put*\" Resource: - \"*\" - Effect: Allow Action: - \"sts:AssumeRole\" Resource: - \"*\" {% else %} RoleToBeAssumed: Type: AWS::IAM::Role Properties: RoleName: RoleToBeAssumed AssumeRolePolicyDocument: Version: \"2012-10-17\" Statement: - Sid: DefaultStatement Effect: \"Allow\" Principal: AWS: - \"arn:aws:iam::{AWS_ACCOUNT}:role/lambda_assume\" Action: - \"sts:AssumeRole\" Path: \"/\" Policies: - PolicyName: \"DeleteCertificates\" PolicyDocument: Version: \"2012-10-17\" Statement: - Effect: \"Allow\" Action: - acm:DeleteCertificate - acm:GetCertificate Action: - acm:ListCertificates Resource: '*' {% endif %} ``` I've already tried true without '' and instead of true is defined but still no success. ", "keywords": ["policy"]}]}, {"Id": "287231602", "PostHistoryTypeId": "1", "PostId": "75308105", "RevisionGUID": "fad45ed0-ab94-4849-90d3-799037a745ec", "CreationDate": "2023-02-01T09:33:19.033", "UserId": "13450573", "Text": "How to use jinja if-else logic together with Ansible inventory", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "287231603", "PostHistoryTypeId": "3", "PostId": "75308105", "RevisionGUID": "fad45ed0-ab94-4849-90d3-799037a745ec", "CreationDate": "2023-02-01T09:33:19.033", "UserId": "13450573", "Text": "|templates|ansible|yaml|jinja2|aws-cloudformation|", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "287231604", "PostHistoryTypeId": "66", "PostId": "75308105", "RevisionGUID": "fad45ed0-ab94-4849-90d3-799037a745ec", "CreationDate": "2023-02-01T09:33:19.033", "UserId": "13450573", "filtered-sentences": []}], "answers": [{"Id": "75309409", "PostTypeId": "2", "ParentId": "75308105", "CreationDate": "2023-02-01T11:19:06.083", "Score": "1", "Body": "<p>The &quot;pythonic&quot; way to write the sentence is just:</p>\n<pre><code>{% if lambda_account %}\n</code></pre>\n<p>But you can still use true with lowercase, as stated in the <a href=\"https://jinja.palletsprojects.com/en/3.1.x/templates/#if\" rel=\"nofollow noreferrer\">jinja2 docs</a>.</p>\n<pre><code>{% if lambda_account == true %}\n</code></pre>\n", "OwnerUserId": "1090745", "LastActivityDate": "2023-02-01T11:19:06.083", "CommentCount": "2", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "132892089", "PostId": "75309409", "Score": "0", "Text": "In an Ansible context, the secure way is `{% if lambda_account | bool %}`", "CreationDate": "2023-02-01T15:38:20.617", "UserId": "9401096", "filtered-sentences": []}, {"Id": "132910161", "PostId": "75309409", "Score": "1", "Text": "Thanks! The first answer worked for me! I was sure I've tested this before (maybe I did other changes to the code and that's why I excluded this option from further testings)", "CreationDate": "2023-02-02T12:20:39.910", "UserId": "13450573", "filtered-sentences": [{"source": "Text", "text": "I was sure I've tested this before (maybe I did other changes to the code and that's why I excluded this option from further testings)", "keywords": ["change", "test"]}]}], "history": [{"Id": "287238826", "PostHistoryTypeId": "2", "PostId": "75309409", "RevisionGUID": "ee1a32c1-b47c-4c50-97d5-6a2a5956fa54", "CreationDate": "2023-02-01T11:19:06.083", "UserId": "1090745", "Text": "The \"pythonic\" way to write the sentence is just:\r\n\r\n```\r\n{% if lambda_account %}\r\n```\r\n\r\nBut you can still use true with lowercase, as stated in the [jinja2 docs](https://jinja.palletsprojects.com/en/3.1.x/templates/#if).\r\n\r\n```\r\n{% if lambda_account == true %}\r\n```\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": []}