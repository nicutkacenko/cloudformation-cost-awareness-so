{"Id": "53849899", "PostTypeId": "1", "AcceptedAnswerId": "53864517", "CreationDate": "2018-12-19T11:03:19.677", "Score": "23", "ViewCount": "16378", "Body": "<p><a href=\"https://aws.amazon.com/about-aws/whats-new/2018/11/amazon-cloudwatch-launches-ability-to-add-alarms-on-metric-math-expressions/\" rel=\"noreferrer\">Recently</a> AWS announced that Cloudwatch alarms can use Math Expressions on metrics. I decided to create an alarm that compares the SUM of 2 single metrics with a given threshold. This means that according to <a href=\"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/using-metric-math.html#metric-math-syntax\" rel=\"noreferrer\">AWS documentation</a> my expression should be SUM([m1,m2]), where m1 and m2 are 2 single metrics.\nI also decided to implement this idea using a cloudformation template (in yaml). Here's the Cloudwatch alarm definition:</p>\n\n<pre><code>BillingAlarmExpression:\n  Type: AWS::CloudWatch::Alarm\n  Properties:\n    AlarmActions:\n      - !Ref BillingAlertTopic\n    AlarmDescription: String\n    ComparisonOperator: GreaterThanOrEqualToThreshold\n    EvaluationPeriods: 1\n    Metrics:\n      - Id: m1\n        MetricStat:\n          Metric:\n            Dimensions:\n              - Name: ServiceName\n                Value: AmazonEC2\n              - Name: Currency\n                Value: USD\n            MetricName: Estimated\u00adCharges\n            Namespace: AWS/Billing\n          Period: 86400\n          Stat: Maximum\n        ReturnData: False\n      - Id: m2\n        MetricStat:\n          Metric:\n            Dimensions:\n              - Name: ServiceName\n                Value: AmazonCloudwatch\n              - Name: Currency\n                Value: USD\n            MetricName: Estimated\u00adCharges\n            Namespace: AWS/Billing\n          Period: 86400\n          Stat: Maximum\n        ReturnData: False\n      - Id: Expr1\n        Expression: SUM([m1,m2])\n        Label: Yeap\n    Threshold: 100\n    TreatMissingData: ignore\n</code></pre>\n\n<p>The single metrics , m1 and m2 , have to do with the billing cost of EC2 and Cloudwatch service. What I want to check is if the charging cost for these 2 services has crossed the threshold of 100$. (Note that since the billing costs are exclusively stored in the N.Virginia region, I tried to deploy the above template in N.Virginia).\nDuring the deployment of this template Cloudformation responds with the following error:</p>\n\n<pre><code>\"Invalid metrics list (Service: AmazonCloudWatch; Status Code: 400; Error Code: ValidationError; Request ID: c0748047-0378-11e9-ac36-5b1829988d18)\"\n</code></pre>\n\n<p>When Cloudformation says \"metrics list\" it refers to the definition of m1,m2, Expr1. What is even more strange is that when I use the above metrics-list definition from aws cli the charging data return successfully:</p>\n\n<pre><code>aws cloudwatch get-metric-data --metric-data-queries file://./metric-data.json --start-time 2018-12-03T03:00:00Z --end-time 2018-12-10T04:30:00Z\n</code></pre>\n\n<p>,where metric-data.json is the above metrics-list.</p>\n\n<p>For creating my template I used the following guides:\n<a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cw-alarm.html\" rel=\"noreferrer\">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cw-alarm.html</a>\nand\n<a href=\"https://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/API_GetMetricData.html\" rel=\"noreferrer\">https://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/API_GetMetricData.html</a></p>\n\n<p>Do you have any idea why Cloudformation returns this error? Thanks!</p>\n", "OwnerUserId": "5508526", "LastActivityDate": "2022-03-08T22:14:11.100", "Title": "Unable to define Math Expression for Cloudwatch Alarm in a Cloudformation Template", "Tags": "|amazon-web-services|aws-cloudformation|amazon-cloudwatch|", "AnswerCount": "2", "CommentCount": "0", "FavoriteCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "188122488", "PostHistoryTypeId": "2", "PostId": "53849899", "RevisionGUID": "eb4c43bb-4d32-4fac-b3f0-1bab20012d9b", "CreationDate": "2018-12-19T11:03:19.677", "UserId": "5508526", "Text": "[Recently][1] AWS announced that Cloudwatch alarms can use Math Expressions on metrics. I decided to create an alarm that compares the SUM of 2 single metrics with a given threshold. This means that according to [AWS documentation][2] my expression should be SUM([m1,m2]), where m1 and m2 are 2 single metrics.\r\nI also decided to implement this idea using a cloudformation template (in yaml). Here's the Cloudwatch alarm definition:\r\n\r\n    BillingAlarmExpression:\r\n      Type: AWS::CloudWatch::Alarm\r\n      Properties:\r\n        AlarmActions:\r\n          - !Ref BillingAlertTopic\r\n        AlarmDescription: String\r\n        ComparisonOperator: GreaterThanOrEqualToThreshold\r\n        EvaluationPeriods: 1\r\n        Metrics:\r\n          - Id: m1\r\n            MetricStat:\r\n              Metric:\r\n                Dimensions:\r\n                  - Name: ServiceName\r\n                    Value: AmazonEC2\r\n                  - Name: Currency\r\n                    Value: USD\r\n                MetricName: Estimated\u00adCharges\r\n                Namespace: AWS/Billing\r\n              Period: 86400\r\n              Stat: Maximum\r\n            ReturnData: False\r\n          - Id: m2\r\n            MetricStat:\r\n              Metric:\r\n                Dimensions:\r\n                  - Name: ServiceName\r\n                    Value: AmazonCloudwatch\r\n                  - Name: Currency\r\n                    Value: USD\r\n                MetricName: Estimated\u00adCharges\r\n                Namespace: AWS/Billing\r\n              Period: 86400\r\n              Stat: Maximum\r\n            ReturnData: False\r\n          - Id: Expr1\r\n            Expression: SUM([m1,m2])\r\n            Label: Yeap\r\n        Threshold: 100\r\n        TreatMissingData: ignore\r\n\r\nThe single metrics , m1 and m2 , have to do with the billing cost of EC2 and Cloudwatch service. What I want to check is if the charging cost for these 2 services has crossed the threshold of 100$. (Note that since the billing costs are exclusively stored in the N.Virginia region, I tried to deploy the above template in N.Virginia).\r\nDuring the deployment of this template Cloudformation responds with the following error:\r\n\r\n    \"Invalid metrics list (Service: AmazonCloudWatch; Status Code: 400; Error Code: ValidationError; Request ID: c0748047-0378-11e9-ac36-5b1829988d18)\"\r\n\r\nWhen Cloudformation says \"metrics list\" it refers to the definition of m1,m2, Expr1. What is even more strange is that when I use the above metrics-list definition from aws cli the charging data return successfully:\r\n\r\n    aws cloudwatch get-metric-data --metric-data-queries file://./metric-data.json --start-time 2018-12-03T03:00:00Z --end-time 2018-12-10T04:30:00Z\r\n\r\n,where metric-data.json is the above metrics-list.\r\n\r\nFor creating my template I used the following guides:\r\nhttps://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cw-alarm.html\r\nand\r\nhttps://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/API_GetMetricData.html\r\n\r\n Do you have any idea why Cloudformation returns this error? Thanks!\r\n\r\n\r\n  [1]: https://aws.amazon.com/about-aws/whats-new/2018/11/amazon-cloudwatch-launches-ability-to-add-alarms-on-metric-math-expressions/\r\n  [2]: https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/using-metric-math.html#metric-math-syntax", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Here's the Cloudwatch alarm definition: BillingAlarmExpression: Type: AWS::CloudWatch::Alarm Properties: AlarmActions: - !Ref BillingAlertTopic AlarmDescription: String ComparisonOperator: GreaterThanOrEqualToThreshold EvaluationPeriods: 1 Metrics: - Id: m1 MetricStat: Metric: Dimensions: - Name: ServiceName Value: AmazonEC2 - Name: Currency Value: USD MetricName: Estimated\u00adCharges Namespace: AWS/Billing Period: 86400 Stat: Maximum ReturnData: False - Id: m2 MetricStat: Metric: Dimensions: - Name: ServiceName Value: AmazonCloudwatch - Name: Currency Value: USD MetricName: Estimated\u00adCharges Namespace: AWS/Billing Period: 86400 Stat: Maximum ReturnData: False - Id: Expr1 Expression: SUM([m1,m2]) Label: Yeap Threshold: 100 TreatMissingData: ignore The single metrics , m1 and m2 , have to do with the billing cost of EC2 and Cloudwatch service. ", "keywords": ["bill", "cost"]}, {"source": "Text", "text": "What I want to check is if the charging cost for these 2 services has crossed the threshold of 100$. ", "keywords": ["cost"]}, {"source": "Text", "text": "(Note that since the billing costs are exclusively stored in the N.Virginia region, I tried to deploy the above template in N.Virginia). ", "keywords": ["bill"]}]}, {"Id": "188122489", "PostHistoryTypeId": "1", "PostId": "53849899", "RevisionGUID": "eb4c43bb-4d32-4fac-b3f0-1bab20012d9b", "CreationDate": "2018-12-19T11:03:19.677", "UserId": "5508526", "Text": "Unable to define Math Expression for Cloudwatch Alarm in a Cloudformation Template", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "188122490", "PostHistoryTypeId": "3", "PostId": "53849899", "RevisionGUID": "eb4c43bb-4d32-4fac-b3f0-1bab20012d9b", "CreationDate": "2018-12-19T11:03:19.677", "UserId": "5508526", "Text": "|amazon-web-services|aws-cloudformation|amazon-cloudwatch|", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "53864517", "PostTypeId": "2", "ParentId": "53849899", "CreationDate": "2018-12-20T07:56:28.377", "Score": "42", "Body": "<p><code>Id</code> must start with a lowercase letter, change <code>Expr1</code> to <code>expr1</code>.</p>\n\n<p>From <a href=\"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/using-metric-math.html\" rel=\"noreferrer\">docs</a>:</p>\n\n<blockquote>\n  <p>You can change the value of Id. It can include numbers, letters, and underscore, and must start with a lowercase letter.</p>\n</blockquote>\n", "OwnerUserId": "1803990", "LastActivityDate": "2018-12-20T07:56:28.377", "CommentCount": "6", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "94582411", "PostId": "53864517", "Score": "1", "Text": "Yeap! That was the problem! Thank you very much!", "CreationDate": "2018-12-20T11:20:23.963", "UserId": "5508526", "filtered-sentences": []}, {"Id": "94583907", "PostId": "53864517", "Score": "0", "Text": "You're welcome! Don't forget to accept the answer :)", "CreationDate": "2018-12-20T12:14:00.663", "UserId": "1803990", "filtered-sentences": []}, {"Id": "100672614", "PostId": "53864517", "Score": "0", "Text": "@P.Str Have you checked if your expression SUM([m1,m2]) is really giving the correct sum? In my case it is not.", "CreationDate": "2019-07-17T11:19:59.630", "UserId": "7616611", "filtered-sentences": []}, {"Id": "106512533", "PostId": "53864517", "Score": "2", "Text": "Found due to \"Invalid Metrics List\"", "CreationDate": "2020-02-13T22:33:36.047", "UserId": "2840591", "filtered-sentences": []}, {"Id": "113273152", "PostId": "53864517", "Score": "0", "Text": "really could use some better error messaging here from Amazon.  Thank you.", "CreationDate": "2020-09-25T01:19:46.017", "UserId": "1173800", "filtered-sentences": []}, {"Id": "134215168", "PostId": "53864517", "Score": "0", "Text": "Of all the dumb syntax requirements AWS has, this one takes the cake!", "CreationDate": "2023-04-25T16:55:13.170", "UserId": "2751039", "filtered-sentences": []}], "history": [{"Id": "188181899", "PostHistoryTypeId": "2", "PostId": "53864517", "RevisionGUID": "240537d2-2fc9-4daf-aaf6-95a0e753c95e", "CreationDate": "2018-12-20T07:56:28.377", "UserId": "1803990", "Text": "`Id` must start with a lowercase letter, change `Expr1` to `expr1`.\r\n\r\nFrom [docs][1]:\r\n\r\n> You can change the value of Id. It can include numbers, letters, and underscore, and must start with a lowercase letter.\r\n\r\n\r\n  [1]: https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/using-metric-math.html", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "`Id` must start with a lowercase letter, change `Expr1` to `expr1`. ", "keywords": ["change"]}, {"source": "Text", "text": "From [docs][1]: > You can change the value of Id. ", "keywords": ["change"]}]}], "filtered-sentences": [{"source": "Body", "text": "Id must start with a lowercase letter, change Expr1 to expr1. ", "keywords": ["change"]}, {"source": "Body", "text": "From docs: You can change the value of Id. ", "keywords": ["change"]}]}, {"Id": "71399433", "PostTypeId": "2", "ParentId": "53849899", "CreationDate": "2022-03-08T17:49:27.130", "Score": "2", "Body": "<p>I also ran into this issue -- in the off chance that your issue is not the accepted answer (<code>id</code> is using lower case), these things are also worth looking out for that can cause the error</p>\n<ul>\n<li>Make sure you're following the proper shape of what a <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cloudwatch-alarm-metricdataquery.html\" rel=\"nofollow noreferrer\"><code>MetricDataQuery</code></a> looks like and take note which properties are actually optional or not</li>\n<li>Make sure the math expression you're writing is a <code>String</code> (surrounded by quotes)</li>\n<li>Make sure you're using proper <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cloudwatch-alarm-metricstat.html\" rel=\"nofollow noreferrer\"><code>MetricStat</code></a> value (using <code>Max</code> instead of <code>Maximum</code> can throw this error)</li>\n</ul>\n<p>I really hope AWS will look to add better error messaging around this. <code>Invalid Metrics list</code> was not very helpful :/</p>\n", "OwnerUserId": "1168661", "LastEditorUserId": "1168661", "LastEditDate": "2022-03-08T22:14:11.100", "LastActivityDate": "2022-03-08T22:14:11.100", "CommentCount": "1", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "136247615", "PostId": "71399433", "Score": "0", "Text": "Also, the Stat's are case sensitive.  `Average`, not `average`", "CreationDate": "2023-10-12T23:35:51.630", "UserId": "120683", "filtered-sentences": []}], "history": [{"Id": "265634840", "PostHistoryTypeId": "5", "PostId": "71399433", "RevisionGUID": "ea560d66-7430-40fc-adf6-07cd0916a5ec", "CreationDate": "2022-03-08T22:14:11.100", "UserId": "1168661", "Comment": "added 119 characters in body", "Text": "I also ran into this issue -- in the off chance that your issue is not the accepted answer (`id` is using lower case), these things are also worth looking out for that can cause the error\r\n\r\n* Make sure you're following the proper shape of what a [`MetricDataQuery`](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cloudwatch-alarm-metricdataquery.html) looks like and take note which properties are actually optional or not\r\n* Make sure the math expression you're writing is a `String` (surrounded by quotes)\r\n* Make sure you're using proper [`MetricStat`](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cloudwatch-alarm-metricstat.html) value (using `Max` instead of `Maximum` can throw this error)\r\n\r\nI really hope AWS will look to add better error messaging around this. `Invalid Metrics list` was not very helpful :/", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "265620597", "PostHistoryTypeId": "2", "PostId": "71399433", "RevisionGUID": "652af80d-0bb2-4a1b-9b24-9d3ca63f0667", "CreationDate": "2022-03-08T17:49:27.130", "UserId": "1168661", "Text": "I also ran into this issue -- in the off chance that your issue is not the accepted answer (`id` is using lower case), these things are also worth looking out for that can cause the error\r\n\r\n* Make sure you're following the proper shape of what a [`MetricDataQuery`](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cloudwatch-alarm-metricdataquery.html) looks like and take note which properties are actually optional or not\r\n* Make sure the math expression you're writing is a `String` (surrounded by quotes)\r\n* Make sure you're using proper [`MetricStat`](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cloudwatch-alarm-metricstat.html) value (using `Max` instead of `Maximum` can throw this error)\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "Here's the Cloudwatch alarm definition: The single metrics , m1 and m2 , have to do with the billing cost of EC2 and Cloudwatch service. ", "keywords": ["bill", "cost"]}, {"source": "Body", "text": "What I want to check is if the charging cost for these 2 services has crossed the threshold of 100$. ", "keywords": ["cost"]}, {"source": "Body", "text": "(Note that since the billing costs are exclusively stored in the N.Virginia region, I tried to deploy the above template in N.Virginia). ", "keywords": ["bill"]}]}