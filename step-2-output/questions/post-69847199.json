{"Id": "69847199", "PostTypeId": "1", "AcceptedAnswerId": "69847788", "CreationDate": "2021-11-04T23:59:40.270", "Score": "0", "ViewCount": "1106", "Body": "<p>I am creating a multi tenant architecture. I need to duplicate my recources whenever a new tenant registers my platform.</p>\n<p>I created a stackset in my SAM project like this:</p>\n<pre><code>StackSet:\n    Type: AWS::CloudFormation::StackSet\n    Properties:\n      Capabilities:\n        - &quot;CAPABILITY_IAM&quot;\n        - &quot;CAPABILITY_NAMED_IAM&quot;\n        - &quot;CAPABILITY_AUTO_EXPAND&quot;\n      AdministrationRoleARN: !GetAtt AdministrationRole.Arn\n      ExecutionRoleName: !Ref ExecutionRole\n      OperationPreferences:\n        FailureToleranceCount: 0\n        MaxConcurrentCount: 1\n      PermissionModel: 'SELF_MANAGED'\n      StackInstancesGroup:\n        - DeploymentTargets:\n            Accounts: \n              - !Ref AWS::AccountId\n          Regions: \n            - !Ref AWS::Region\n        - DeploymentTargets:\n            Accounts: \n              - !Ref AWS::AccountId\n          Regions: \n            - !Ref AWS::Region\n      Tags:\n        - \n          Key: 'PROJECT'\n          Value: 'imaclegal'\n      StackSetName: 'imaclegal'\n      TemplateURL: 'https://s3.amazonaws.com/a-child-s3/output.yaml'\n</code></pre>\n<p>When I execute <code>sam deploy</code> I get this error:</p>\n<blockquote>\n<p>Properties validation failed for resource StackSet   with message: #:\n#: only 1 subschema matches out of 2  #/StackInstancesGroup: array items are not unique</p>\n</blockquote>\n<p>So it seems I can not get to deploy more than 1 instance in the same AWS account and region, is there any way to accomplish multiple instances in the same AWS account and region? Or is there any other better way to duplicate my resources for my new tenants?</p>\n", "OwnerUserId": "1132822", "LastActivityDate": "2021-11-05T01:43:03.340", "Title": "How to deploy multiple instances of the same stackset in the same AWS account and region?", "Tags": "|amazon-web-services|aws-cloudformation|multi-tenant|aws-sam|", "AnswerCount": "1", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "257316267", "PostHistoryTypeId": "2", "PostId": "69847199", "RevisionGUID": "6cb78513-3a1b-4fb2-b071-adb878b2033d", "CreationDate": "2021-11-04T23:59:40.270", "UserId": "1132822", "Text": "I am creating a multi tenant architecture. I need to duplicate my recources whenever a new tenant registers my platform.\r\n\r\nI created a stackset in my SAM project like this:\r\n\r\n    StackSet:\r\n        Type: AWS::CloudFormation::StackSet\r\n        Properties:\r\n          Capabilities:\r\n            - \"CAPABILITY_IAM\"\r\n            - \"CAPABILITY_NAMED_IAM\"\r\n            - \"CAPABILITY_AUTO_EXPAND\"\r\n          AdministrationRoleARN: !GetAtt AdministrationRole.Arn\r\n          ExecutionRoleName: !Ref ExecutionRole\r\n          OperationPreferences:\r\n            FailureToleranceCount: 0\r\n            MaxConcurrentCount: 1\r\n          PermissionModel: 'SELF_MANAGED'\r\n          StackInstancesGroup:\r\n            - DeploymentTargets:\r\n                Accounts: \r\n                  - !Ref AWS::AccountId\r\n              Regions: \r\n                - !Ref AWS::Region\r\n            - DeploymentTargets:\r\n                Accounts: \r\n                  - !Ref AWS::AccountId\r\n              Regions: \r\n                - !Ref AWS::Region\r\n          Tags:\r\n            - \r\n              Key: 'PROJECT'\r\n              Value: 'imaclegal'\r\n          StackSetName: 'imaclegal'\r\n          TemplateURL: 'https://s3.amazonaws.com/a-child-s3/output.yaml'\r\n\r\nWhen I execute `sam deploy` I get this error:\r\n\r\n> Properties validation failed for resource StackSet   with message: #:\r\n> #: only 1 subschema matches out of 2  #/StackInstancesGroup: array items are not unique\r\n\r\nSo it seems I can not get to deploy more than 1 instance in the same AWS account and region, is there any way to accomplish multiple instances in the same AWS account and region? Or is there any other better way to duplicate my resources for my new tenants?\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "So it seems I can not get to deploy more than 1 instance in the same AWS account and region, is there any way to accomplish multiple instances in the same AWS account and region? ", "keywords": ["instance"]}]}, {"Id": "257316269", "PostHistoryTypeId": "1", "PostId": "69847199", "RevisionGUID": "6cb78513-3a1b-4fb2-b071-adb878b2033d", "CreationDate": "2021-11-04T23:59:40.270", "UserId": "1132822", "Text": "How to deploy multiple instances of the same stackset in the same AWS account and region?", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "257316270", "PostHistoryTypeId": "3", "PostId": "69847199", "RevisionGUID": "6cb78513-3a1b-4fb2-b071-adb878b2033d", "CreationDate": "2021-11-04T23:59:40.270", "UserId": "1132822", "Text": "|amazon-web-services|aws-cloudformation|multi-tenant|aws-sam|", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "69847788", "PostTypeId": "2", "ParentId": "69847199", "CreationDate": "2021-11-05T01:43:03.340", "Score": "2", "Body": "<p>If you want to keep all resources in a single account/region, CloudFormation StackSets currently won't do what you need.\nIf your resources aren't named within your template, you could just create multiple CloudFormation stacks. This could get messy to maintain though, and you're more likely to hit service quotas if you're running the applications at scale.</p>\n<p>Personally, I recommend using AWS Organizations to create an account for each tenant. CloudFormation StackSets can then be used to automatically duplicate your resources to new accounts.</p>\n<p>This solution also has the added benefit of more precise cost-allocation for each tenant.</p>\n", "OwnerUserId": "3569854", "LastActivityDate": "2021-11-05T01:43:03.340", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "257319341", "PostHistoryTypeId": "2", "PostId": "69847788", "RevisionGUID": "e4e60418-da1c-4acb-affb-f0cd8ff6d7c5", "CreationDate": "2021-11-05T01:43:03.340", "UserId": "3569854", "Text": "If you want to keep all resources in a single account/region, CloudFormation StackSets currently won't do what you need. \r\nIf your resources aren't named within your template, you could just create multiple CloudFormation stacks. This could get messy to maintain though, and you're more likely to hit service quotas if you're running the applications at scale.\r\n\r\nPersonally, I recommend using AWS Organizations to create an account for each tenant. CloudFormation StackSets can then be used to automatically duplicate your resources to new accounts. \r\n\r\nThis solution also has the added benefit of more precise cost-allocation for each tenant.", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "This solution also has the added benefit of more precise cost-allocation for each tenant.", "keywords": ["cost"]}]}], "filtered-sentences": [{"source": "Body", "text": "This solution also has the added benefit of more precise cost-allocation for each tenant.", "keywords": ["cost"]}]}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "So it seems I can not get to deploy more than 1 instance in the same AWS account and region, is there any way to accomplish multiple instances in the same AWS account and region? ", "keywords": ["instance"]}]}