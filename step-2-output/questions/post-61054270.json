{"Id": "61054270", "PostTypeId": "1", "AcceptedAnswerId": "61099792", "CreationDate": "2020-04-06T06:41:37.097", "Score": "0", "ViewCount": "1142", "Body": "<p>I've implemented an API gateway endpoint that sends messages to the SNS topic when new requests are coming. In common, it works perfectly except the cases when I am trying to send a large payload to the SNS topic. In this case, I've got a bad request from SNS API even If I do not exceed the SNS or API Gateway limits and quotas. \nFor example, I am getting this message if I will send the next payload which will consist of 15k letters 'a' or if the array will contain about 8k integers: </p>\n\n<blockquote>\n  <p>{\n      \"count\": 1,\n      \"data\": \"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa... .\",\n      \"flag\": 1,\n      \"arr\": <a href=\"https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-swagger-extensions-integration-requestParameters.html\" rel=\"nofollow noreferrer\">1</a>\n  }</p>\n</blockquote>\n\n<p>As I understand the reason for such behavior is hidden in the next line of code in my CloudFormation template: </p>\n\n<pre><code>integration.request.querystring.Message: \"method.request.body\"\nintegration.request.querystring.TopicArn: !Sub \"'${some-topic-arn}'\"\n</code></pre>\n\n<p>According to the <a href=\"https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-swagger-extensions-integration-requestParameters.html\" rel=\"nofollow noreferrer\">documentation</a> we could use <strong>body</strong> type instead of <strong>querystring</strong>  but it is didn't works. \nAlso, I have tried to use request template mapping and send <strong>topicArn</strong> via querystring and the message via template mapping. But it is also doesn't works. </p>\n\n<p>So can anyone told me what I am doing wrong and how to solve the issue with getting bad request error when sending large payload via HTTP POST request?</p>\n\n<p>Here is my current CloudFormation template: \n    /v1/someApiEndpoint:\n            post:\n              requestBody:\n                content:\n                  application/json:\n                    schema:\n                      $ref: \"#/components/schemas/SomeApiModel\"\n                required: true\n              responses:\n                '200':\n                  description: \"200 response\"\n                ....</p>\n\n<pre><code>            '500':\n              description: \"500 response\"\n              content:\n                application/json:\n                  schema:\n                    $ref: \"#/components/schemas/ErrorMessage\"\n\n          x-amazon-apigateway-request-validator: \"SomeApiModelValidator\"\n          x-amazon-apigateway-integration:\n            type: \"aws\"\n            httpMethod: \"POST\"\n            uri: !Sub \"arn:aws:apigateway:${AWS::Region}:sns:action/Publish\"\n            credentials: !GetAtt SomeApiRole.Arn\n            responses:\n              '2\\d{2}':\n                statusCode: 200\n            requestParameters:\n              integration.request.header.Content-Type: \"'application/x-www-form-urlencoded'\"\n              integration.request.querystring.Message: \"method.request.body\"\n              integration.request.querystring.TopicArn: !Sub \"'${SomeTopicArn}'\"\n            passthroughBehavior: \"NEVER\"\n            requestTemplates:\n              application/json: |\n               #set($input.path('$').payload = { \"userIdentity\": $util.parseJson($context.authorizer.userIdentity), \"data\": $util.parseJson($input.body) })\n               #set($encodedJson = $util.urlEncode($input.json('$.payload')))\n</code></pre>\n\n<p>Here is my model definition which I sends to API gateway and then transfer to SNS topic: </p>\n\n<pre><code>class SomeApiModel\n{\n  int count; \n  string data; \n  int flag;\n  int[] arr;\n}\n</code></pre>\n", "OwnerUserId": "1179843", "LastActivityDate": "2020-04-08T11:39:43.600", "Title": "Unable to send large payload to SNS topic from API Gateway", "Tags": "|amazon-web-services|aws-cloudformation|aws-api-gateway|amazon-sns|", "AnswerCount": "1", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "218529028", "PostHistoryTypeId": "2", "PostId": "61054270", "RevisionGUID": "7000ea9c-bee0-41e8-a6bb-de666c644b29", "CreationDate": "2020-04-06T06:41:37.097", "UserId": "1179843", "Text": "I've implemented an API gateway endpoint that sends messages to the SNS topic when new requests are coming. In common, it works perfectly except the cases when I am trying to send a large payload to the SNS topic. In this case, I've got a bad request from SNS API even If I do not exceed the SNS or API Gateway limits and quotas. \r\nFor example, I am getting this message if I will send the next payload which will consist of 15k letters 'a' or if the array will contain about 8k integers: \r\n\r\n> {\r\n \"count\": 1,\r\n \"data\": \"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa... .\",\r\n \"flag\": 1,\r\n \"arr\": [1]\r\n}\r\n\r\n\r\nAs I understand the reason for such behavior is hidden in the next line of code in my CloudFormation template: \r\n\r\n    integration.request.querystring.Message: \"method.request.body\"\r\n    integration.request.querystring.TopicArn: !Sub \"'${some-topic-arn}'\"\r\n\r\n\r\nAccording to the [documentation][1] we could use **body** type instead of **querystring**  but it is didn't works. \r\nAlso, I have tried to use request template mapping and send **topicArn** via querystring and the message via template mapping. But it is also doesn't works. \r\n\r\nSo can anyone told me what I am doing wrong and how to solve the issue with getting bad request error when sending large payload via HTTP POST request?\r\n\r\nHere is my current CloudFormation template: \r\n    /v1/someApiEndpoint:\r\n            post:\r\n              requestBody:\r\n                content:\r\n                  application/json:\r\n                    schema:\r\n                      $ref: \"#/components/schemas/SomeApiModel\"\r\n                required: true\r\n              responses:\r\n                '200':\r\n                  description: \"200 response\"\r\n                ....\r\n\r\n                '500':\r\n                  description: \"500 response\"\r\n                  content:\r\n                    application/json:\r\n                      schema:\r\n                        $ref: \"#/components/schemas/ErrorMessage\"\r\n                        \r\n              x-amazon-apigateway-request-validator: \"SomeApiModelValidator\"\r\n              x-amazon-apigateway-integration:\r\n                type: \"aws\"\r\n                httpMethod: \"POST\"\r\n                uri: !Sub \"arn:aws:apigateway:${AWS::Region}:sns:action/Publish\"\r\n                credentials: !GetAtt SomeApiRole.Arn\r\n                responses:\r\n                  '2\\d{2}':\r\n                    statusCode: 200\r\n                requestParameters:\r\n                  integration.request.header.Content-Type: \"'application/x-www-form-urlencoded'\"\r\n                  integration.request.querystring.Message: \"method.request.body\"\r\n                  integration.request.querystring.TopicArn: !Sub \"'${SomeTopicArn}'\"\r\n                passthroughBehavior: \"NEVER\"\r\n                requestTemplates:\r\n                  application/json: |\r\n                   #set($input.path('$').payload = { \"userIdentity\": $util.parseJson($context.authorizer.userIdentity), \"data\": $util.parseJson($input.body) })\r\n                   #set($encodedJson = $util.urlEncode($input.json('$.payload')))\r\n\r\n\r\nHere is my model definition which I sends to API gateway and then transfer to SNS topic: \r\n\r\n    class SomeApiModel\r\n    {\r\n      int count; \r\n      string data; \r\n      int flag;\r\n      int[] arr;\r\n    }\r\n\r\n\r\n  [1]: https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-swagger-extensions-integration-requestParameters.html", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "218529029", "PostHistoryTypeId": "1", "PostId": "61054270", "RevisionGUID": "7000ea9c-bee0-41e8-a6bb-de666c644b29", "CreationDate": "2020-04-06T06:41:37.097", "UserId": "1179843", "Text": "Unable to send large payload to SNS topic from API Gateway", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "218529030", "PostHistoryTypeId": "3", "PostId": "61054270", "RevisionGUID": "7000ea9c-bee0-41e8-a6bb-de666c644b29", "CreationDate": "2020-04-06T06:41:37.097", "UserId": "1179843", "Text": "|amazon-web-services|aws-cloudformation|aws-api-gateway|amazon-sns|", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "61099792", "PostTypeId": "2", "ParentId": "61054270", "CreationDate": "2020-04-08T11:39:43.600", "Score": "1", "Body": "<p>Ok, I got it. </p>\n\n<p>After many hours spent on the investigation, I finally found the problem and fixed it. \nAs was mentioned by <a href=\"https://stackoverflow.com/users/1695906/michael-sqlbot\">Michael-sqlbot</a> in the next <a href=\"https://stackoverflow.com/a/49566676/1179843\">post about API GW and SQS integration</a> we need to override the path to SNS publish endpoint. \nBtw, thanks you saved my life =)</p>\n\n<p>In case if someone will also stumble this issue here is a solution: </p>\n\n<ol>\n<li>First of all. Replace the <strong>URI</strong> property inside <strong>x-amazon-apigateway-integration:</strong> section from this:</li>\n</ol>\n\n<blockquote>\n  <p>uri: !Sub \"arn:aws:apigateway:${AWS::Region}:sns:action/Publish\"`</p>\n</blockquote>\n\n<p>to this: </p>\n\n<blockquote>\n  <p>uri: !Sub \"arn:aws:apigateway:${AWS::Region}:sns:path//\"</p>\n</blockquote>\n\n<p>It will override the path as </p>\n\n<ol start=\"2\">\n<li>Remove next two lines of code from integration request parameter section:</li>\n</ol>\n\n<blockquote>\n<pre><code>integration.request.querystring.Message: \"method.request.body\"\nintegration.request.querystring.TopicArn: !Sub \"'${SomeTopicArn}'\"\n</code></pre>\n</blockquote>\n\n<ol start=\"3\">\n<li>Put TopicArn, Message and Action parameters inside body request template:\nrequestTemplates:</li>\n</ol>\n\n<blockquote>\n<pre><code>application/json:\n    !Sub Action=Publish&amp;TopicArn=$util.urlEncode('${my-topic-arn}')&amp;Message=$util.urlEncode($input.body)##\n</code></pre>\n</blockquote>\n\n<p>Here is complete CloudFormation template definition for this integration: </p>\n\n<pre><code>             x-amazon-apigateway-integration:\n                type: \"aws\"\n                httpMethod: \"POST\"\n                uri: !Sub \"arn:aws:apigateway:${AWS::Region}:sns:path//\"\n                credentials: !GetAtt my-personal-role.Arn\n                responses:\n                  '2\\d{2}':\n                    statusCode: 200\n                requestParameters:\n                  integration.request.header.Content-Type: \"'application/x-www-form-urlencoded'\"\n                passthroughBehavior: \"NEVER\"\n                requestTemplates:\n                  application/json:\n                    !Sub Action=Publish&amp;TopicArn=$util.urlEncode('${my-topic-arn}')&amp;Message=$util.urlEncode($input.body)##\n</code></pre>\n\n<p>Pay attention to <strong>Content-Type</strong> property. It should be surrounded by single quotas `` as a single word. </p>\n", "OwnerUserId": "1179843", "LastActivityDate": "2020-04-08T11:39:43.600", "CommentCount": "1", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "112672585", "PostId": "61099792", "Score": "0", "Text": "I am running into the same issue. For requestTemplates how can I substitute The value of ${my-topic-arn} with the ARN of an SNS topic that is created within the same Clouformation YAML  @Tequila", "CreationDate": "2020-09-03T05:07:55.843", "UserId": "11235251", "filtered-sentences": []}], "history": [{"Id": "218717503", "PostHistoryTypeId": "2", "PostId": "61099792", "RevisionGUID": "cca6ae7b-680f-48c5-be2e-08e34d9c5834", "CreationDate": "2020-04-08T11:39:43.600", "UserId": "1179843", "Text": "Ok, I got it. \r\n\r\nAfter many hours spent on the investigation, I finally found the problem and fixed it. \r\nAs was mentioned by [Michael-sqlbot][1] in the next [post about API GW and SQS integration][2] we need to override the path to SNS publish endpoint. \r\nBtw, thanks you saved my life =)\r\n\r\nIn case if someone will also stumble this issue here is a solution: \r\n\r\n1. First of all. Replace the **URI** property inside **x-amazon-apigateway-integration:** section from this:\r\n\r\n> uri: !Sub \"arn:aws:apigateway:${AWS::Region}:sns:action/Publish\"`\r\n\r\nto this: \r\n\r\n> uri: !Sub \"arn:aws:apigateway:${AWS::Region}:sns:path//\"\r\n\r\nIt will override the path as \r\n\r\n\r\n2. Remove next two lines of code from integration request parameter section:\r\n\r\n>     integration.request.querystring.Message: \"method.request.body\"\r\n>     integration.request.querystring.TopicArn: !Sub \"'${SomeTopicArn}'\"\r\n\r\n\r\n3. Put TopicArn, Message and Action parameters inside body request template:\r\nrequestTemplates:\r\n\r\n>     application/json:\r\n>         !Sub Action=Publish&TopicArn=$util.urlEncode('${my-topic-arn}')&Message=$util.urlEncode($input.body)##\r\n\r\n\r\nHere is complete CloudFormation template definition for this integration: \r\n\r\n                 x-amazon-apigateway-integration:\r\n                    type: \"aws\"\r\n                    httpMethod: \"POST\"\r\n                    uri: !Sub \"arn:aws:apigateway:${AWS::Region}:sns:path//\"\r\n                    credentials: !GetAtt my-personal-role.Arn\r\n                    responses:\r\n                      '2\\d{2}':\r\n                        statusCode: 200\r\n                    requestParameters:\r\n                      integration.request.header.Content-Type: \"'application/x-www-form-urlencoded'\"\r\n                    passthroughBehavior: \"NEVER\"\r\n                    requestTemplates:\r\n                      application/json:\r\n                        !Sub Action=Publish&TopicArn=$util.urlEncode('${my-topic-arn}')&Message=$util.urlEncode($input.body)##\r\n\r\n\r\nPay attention to **Content-Type** property. It should be surrounded by single quotas `` as a single word. \r\n\r\n\r\n  [1]: https://stackoverflow.com/users/1695906/michael-sqlbot\r\n  [2]: https://stackoverflow.com/a/49566676/1179843", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Remove next two lines of code from integration request parameter section: > integration.request.querystring.Message: \"method.request.body\" > integration.request.querystring.TopicArn: !Sub \"'${SomeTopicArn}'\" 3. Put TopicArn, Message and Action parameters inside body request template: requestTemplates: > application/json: > !Sub Action=Publish&TopicArn=$util.urlEncode('${my-topic-arn}')&Message=$util.urlEncode($input.body)## Here is complete CloudFormation template definition for this integration: x-amazon-apigateway-integration: type: \"aws\" httpMethod: \"POST\" uri: !Sub \"arn:aws:apigateway:${AWS::Region}:sns:path//\" credentials: !GetAtt my-personal-role.Arn responses: '2\\d{2}': statusCode: 200 requestParameters: integration.request.header.Content-Type: \"'application/x-www-form-urlencoded'\" passthroughBehavior: \"NEVER\" requestTemplates: application/json: !Sub Action=Publish&TopicArn=$util.urlEncode('${my-topic-arn}')&Message=$util.urlEncode($input.body)## Pay attention to **Content-Type** property. It should be surrounded by single quotas `` as a single word. [1]: https://stackoverflow.com/users/1695906/michael-sqlbot [2]: https://stackoverflow.com/a/49566676/1179843", "keywords": ["pay"]}]}], "filtered-sentences": [{"source": "Body", "text": "It will override the path as Remove next two lines of code from integration request parameter section: Put TopicArn, Message and Action parameters inside body request template: requestTemplates: Here is complete CloudFormation template definition for this integration: Pay attention to Content-Type property. ", "keywords": ["pay"]}]}], "contains-topic": false, "filtered-sentences": []}