{"Id": "77380860", "PostTypeId": "1", "AcceptedAnswerId": "77380968", "CreationDate": "2023-10-28T19:11:02.937", "Score": "1", "ViewCount": "94", "Body": "<p>I've been trying to connect my ApiGateway RestApi to my WAF WebACL for some time now.</p>\n<p>I am working with the serverless framework so I have the Cloudformation template serverless.yml.</p>\n<p>Here is my setup:</p>\n<pre><code>    MyWafWebACL:\n      Type: 'AWS::WAFv2::WebACL'\n      Properties:\n        Name: 'WhitelistedIPsWebACL'\n        Scope: 'REGIONAL'\n        DefaultAction:\n          Allow: {}\n        Rules:\n          - Name: 'AllowWhitelistedIPsIPv4'\n            Priority: 0\n            Action:\n              Allow: {}\n            Statement:\n              IPSetReferenceStatement:\n                ARN: !GetAtt MyWafIPSetIPv4.Arn\n            VisibilityConfig:\n              SampledRequestsEnabled: true\n              CloudWatchMetricsEnabled: true\n              MetricName: 'AllowWhitelistedIPsIPv4Metric'\n          - Name: 'AllowWhitelistedIPsIPv6'\n            Priority: 1\n            Action:\n              Allow: {}\n            Statement:\n              IPSetReferenceStatement:\n                ARN: !GetAtt MyWafIPSetIPv6.Arn\n            VisibilityConfig:\n              SampledRequestsEnabled: true\n              CloudWatchMetricsEnabled: true\n              MetricName: 'AllowWhitelistedIPsIPv6Metric'\n        VisibilityConfig:\n          SampledRequestsEnabled: true\n          CloudWatchMetricsEnabled: true\n          MetricName: 'WhitelistedIPsMetric'\n\n    ApiGatewayRestApi:\n      Type: 'AWS::ApiGateway::RestApi'\n      Properties:\n        Name: 'ApiGatewayRestApi'\n        Description: 'Standard REST gateway'\n\n    MyWafWebACLAssociation:\n      Type: 'AWS::WAFv2::WebACLAssociation'\n      Properties:\n        WebAclArn: !Ref MyWafWebACL\n        ResourceArn: !Sub &quot;arn:aws:apigateway:${AWS::Region}::/restapis/${ApiGatewayRestApi}/stages/dev&quot;\n</code></pre>\n<p>When commenting out the WebACLAssociation everything deploys fine and the resources are created correctly. I can also make the association in the web interface without issue but I want to deploy to different stages and having to do this manually when it should work normally is error-prone and I would like to avoid it at all cost.</p>\n<p>I have tried the following:</p>\n<ul>\n<li>Use the ResourceArn directly as in no !Sub but the exact ARN -&gt; &quot;ARN isn't valid&quot;</li>\n<li>Use the ResourceArn with the id of the Path &quot;/&quot; -&gt; &quot;Resource doesn't exist&quot;</li>\n<li>Use various other formats of creating the ResourceArn like fn join etc. -&gt; &quot;ARN isn't valid&quot;</li>\n</ul>\n<p>Does anybody have an idea why this could be happening?</p>\n<p>Thanks in advance.</p>\n", "OwnerUserId": "13215289", "LastActivityDate": "2023-10-28T19:39:01.757", "Title": "WAFv2 WebACLAssociation \"The ARN isn't valid\" - direct setup works", "Tags": "|amazon-web-services|rest|aws-cloudformation|serverless-framework|amazon-waf|", "AnswerCount": "1", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "299532149", "PostHistoryTypeId": "2", "PostId": "77380860", "RevisionGUID": "abce63ad-0233-47ef-830c-6e5f37e98874", "CreationDate": "2023-10-28T19:11:02.937", "UserId": "13215289", "Text": "I've been trying to connect my ApiGateway RestApi to my WAF WebACL for some time now.\r\n\r\nI am working with the serverless framework so I have the Cloudformation template serverless.yml.\r\n\r\nHere is my setup:\r\n\r\n```\r\n    MyWafWebACL:\r\n      Type: 'AWS::WAFv2::WebACL'\r\n      Properties:\r\n        Name: 'WhitelistedIPsWebACL'\r\n        Scope: 'REGIONAL'\r\n        DefaultAction:\r\n          Allow: {}\r\n        Rules:\r\n          - Name: 'AllowWhitelistedIPsIPv4'\r\n            Priority: 0\r\n            Action:\r\n              Allow: {}\r\n            Statement:\r\n              IPSetReferenceStatement:\r\n                ARN: !GetAtt MyWafIPSetIPv4.Arn\r\n            VisibilityConfig:\r\n              SampledRequestsEnabled: true\r\n              CloudWatchMetricsEnabled: true\r\n              MetricName: 'AllowWhitelistedIPsIPv4Metric'\r\n          - Name: 'AllowWhitelistedIPsIPv6'\r\n            Priority: 1\r\n            Action:\r\n              Allow: {}\r\n            Statement:\r\n              IPSetReferenceStatement:\r\n                ARN: !GetAtt MyWafIPSetIPv6.Arn\r\n            VisibilityConfig:\r\n              SampledRequestsEnabled: true\r\n              CloudWatchMetricsEnabled: true\r\n              MetricName: 'AllowWhitelistedIPsIPv6Metric'\r\n        VisibilityConfig:\r\n          SampledRequestsEnabled: true\r\n          CloudWatchMetricsEnabled: true\r\n          MetricName: 'WhitelistedIPsMetric'\r\n\r\n    ApiGatewayRestApi:\r\n      Type: 'AWS::ApiGateway::RestApi'\r\n      Properties:\r\n        Name: 'ApiGatewayRestApi'\r\n        Description: 'Standard REST gateway'\r\n\r\n    MyWafWebACLAssociation:\r\n      Type: 'AWS::WAFv2::WebACLAssociation'\r\n      Properties:\r\n        WebAclArn: !Ref MyWafWebACL\r\n        ResourceArn: !Sub \"arn:aws:apigateway:${AWS::Region}::/restapis/${ApiGatewayRestApi}/stages/dev\"\r\n```\r\n\r\nWhen commenting out the WebACLAssociation everything deploys fine and the resources are created correctly. I can also make the association in the web interface without issue but I want to deploy to different stages and having to do this manually when it should work normally is error-prone and I would like to avoid it at all cost.\r\n\r\nI have tried the following:\r\n\r\n- Use the ResourceArn directly as in no !Sub but the exact ARN -> \"ARN isn't valid\"\r\n- Use the ResourceArn with the id of the Path \"/\" -> \"Resource doesn't exist\"\r\n- Use various other formats of creating the ResourceArn like fn join etc. -> \"ARN isn't valid\"\r\n\r\nDoes anybody have an idea why this could be happening?\r\n\r\nThanks in advance.", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "I can also make the association in the web interface without issue but I want to deploy to different stages and having to do this manually when it should work normally is error-prone and I would like to avoid it at all cost. ", "keywords": ["cost"]}]}, {"Id": "299532151", "PostHistoryTypeId": "1", "PostId": "77380860", "RevisionGUID": "abce63ad-0233-47ef-830c-6e5f37e98874", "CreationDate": "2023-10-28T19:11:02.937", "UserId": "13215289", "Text": "WAFv2 WebACLAssociation \"The ARN isn't valid\" - direct setup works", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "299532152", "PostHistoryTypeId": "3", "PostId": "77380860", "RevisionGUID": "abce63ad-0233-47ef-830c-6e5f37e98874", "CreationDate": "2023-10-28T19:11:02.937", "UserId": "13215289", "Text": "|amazon-web-services|rest|aws-cloudformation|serverless-framework|amazon-waf|", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "77380968", "PostTypeId": "2", "ParentId": "77380860", "CreationDate": "2023-10-28T19:39:01.757", "Score": "1", "Body": "<p>I found the answer when searching through repost.</p>\n<p>It is mentioned <a href=\"https://repost.aws/questions/QUzpvTS6I6RXee9qmsdEz3lQ/can-t-associate-webacl-to-api-gateway-by-cloudformation\" rel=\"nofollow noreferrer\">here</a> that the issue is not the ResourceArn of the apigateway but the WebAclArn. The error messages being thrown are wrong.</p>\n<p>The WebAclArn cannot be referenced like <code>!Ref MyWafWebACL</code> because this seems to be an object with multiple values. The correct reference is <code>!GetAtt MyWafWebACL.Arn</code> which points to the arn directly.</p>\n<p>This solved my issues.</p>\n", "OwnerUserId": "13215289", "LastActivityDate": "2023-10-28T19:39:01.757", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "299532760", "PostHistoryTypeId": "2", "PostId": "77380968", "RevisionGUID": "65a69b03-1d6e-4213-bed7-09ed5d93d57b", "CreationDate": "2023-10-28T19:39:01.757", "UserId": "13215289", "Text": "I found the answer when searching through repost.\r\n\r\n\r\nIt is mentioned [here][1] that the issue is not the ResourceArn of the apigateway but the WebAclArn. The error messages being thrown are wrong.\r\n\r\nThe WebAclArn cannot be referenced like `!Ref MyWafWebACL` because this seems to be an object with multiple values. The correct reference is `!GetAtt MyWafWebACL.Arn` which points to the arn directly.\r\n\r\nThis solved my issues.\r\n\r\n\r\n  [1]: https://repost.aws/questions/QUzpvTS6I6RXee9qmsdEz3lQ/can-t-associate-webacl-to-api-gateway-by-cloudformation", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": false, "filtered-sentences": [{"source": "Body", "text": "I can also make the association in the web interface without issue but I want to deploy to different stages and having to do this manually when it should work normally is error-prone and I would like to avoid it at all cost. ", "keywords": ["cost"]}]}