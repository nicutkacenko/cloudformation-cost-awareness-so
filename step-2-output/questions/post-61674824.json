{"Id": "61674824", "PostTypeId": "1", "CreationDate": "2020-05-08T08:12:43.903", "Score": "4", "ViewCount": "1399", "Body": "<p>Good day.</p>\n\n<p>My cloudformation stack keeps getting rolled back due to the error for the WaitCondition.</p>\n\n<p>The EC2 instance has Userdata which calls custom bootstrap.sh that uses cfn-signal with the waithandle.url (replaced sensitive info with \"masked\"):</p>\n\n<pre><code>cfn-signal --success true --http-proxy http://proxyAbc:123 --https-proxy http://proxyAbc:123  --region ap-southeast-2 https://cloudformation-waitcondition-ap-southeast-2.s3-ap-southeast-2.amazonaws.com/arn%3Aaws%3Acloudformation%3Aap-southeast-2%3A747462550105%3Astack/asg-masked-20200508162554-0b080289adf738030/35459000-90f5-11ea-a7af-0a0ad6464e74/WaitHandle?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Date=20200508T062906Z&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Expires=86399&amp;X-Amz-Credential=masked&amp;X-Amz-Signature=masked\n</code></pre>\n\n<p>However it is encountering this error now:</p>\n\n<pre><code>Error signaling CloudFormation: [Errno 403] HTTP Error 403 : AccessDeniedAccess DeniedXYZ...123\n</code></pre>\n\n<p>There has been no code change <strong>except for using a new Centos 7 AMI</strong>.</p>\n\n<p>Has anyone encountered this error and managed to resolve it?</p>\n\n<p><strong>Edit:</strong>\nThe userdata has this in the CloudFormation template (which has single-quote surrounding it), where the WAITHANDLE environment variable is used in the cfn-signal command above (the <a href=\"https://cloudformation-waitcondition-ap-southeast-2...\" rel=\"nofollow noreferrer\">https://cloudformation-waitcondition-ap-southeast-2...</a>.):</p>\n\n<pre><code>BASH_SCRIPT[8]=\\\"export WAITHANDLE='\", {\"Ref\": \"WaitHandle\"}, \"'\\\"\\n\n</code></pre>\n", "OwnerUserId": "849256", "LastEditorUserId": "849256", "LastEditDate": "2020-05-14T03:34:24.037", "LastActivityDate": "2020-05-19T09:30:26.290", "Title": "What is causing cfn-signal with waithandle.url to get 403 error", "Tags": "|amazon-web-services|aws-cloudformation|amazon-ami|", "AnswerCount": "1", "CommentCount": "2", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "109093162", "PostId": "61674824", "Score": "0", "Text": "The waithandle url is complex. Sometimes having it in quotes, helps to solve some strange issues when called in user data.", "CreationDate": "2020-05-08T08:21:47.980", "UserId": "248823", "filtered-sentences": []}, {"Id": "109211453", "PostId": "61674824", "Score": "0", "Text": "@Marcin thanks for the comment, but yes it is surrounded in single quotes.", "CreationDate": "2020-05-12T01:09:56.810", "UserId": "849256", "filtered-sentences": []}], "history": [{"Id": "221119604", "PostHistoryTypeId": "2", "PostId": "61674824", "RevisionGUID": "064a226b-32aa-4ad8-86fb-0d09e57e7b44", "CreationDate": "2020-05-08T08:12:43.903", "UserId": "849256", "Text": "Good day.\r\n\r\nMy cloudformation stack keeps getting rolled back due to the error for the WaitCondition.\r\n\r\nThe EC2 instance has Userdata which calls custom bootstrap.sh that uses cfn-signal with the waithandle.url (replaced sensitive info with \"masked\"):\r\n\r\n    cfn-signal --success true --http-proxy http://awsproxy:8989 --https-proxy http://awsproxy:8989  --region ap-southeast-2 https://cloudformation-waitcondition-ap-southeast-2.s3-ap-southeast-2.amazonaws.com/arn%3Aaws%3Acloudformation%3Aap-southeast-2%3A747462550105%3Astack/asg-masked-20200508162554-0b080289adf738030/35459000-90f5-11ea-a7af-0a0ad6464e74/WaitHandle?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20200508T062906Z&X-Amz-SignedHeaders=host&X-Amz-Expires=86399&X-Amz-Credential=masked&X-Amz-Signature=masked\r\n\r\nHowever it is encountering this error now:\r\n\r\n    Error signaling CloudFormation: [Errno 403] HTTP Error 403 : AccessDeniedAccess DeniedXYZ...123\r\n\r\nThere has been no code change **except for using a new Centos 7 AMI**.\r\n\r\nHas anyone encountered this error and managed to resolve it?", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "The EC2 instance has Userdata which calls custom bootstrap.sh that uses cfn-signal with the waithandle.url (replaced sensitive info with \"masked\"): cfn-signal --success true --http-proxy http://awsproxy:8989 --https-proxy http://awsproxy:8989 --region ap-southeast-2 https://cloudformation-waitcondition-ap-southeast-2.s3-ap-southeast-2.amazonaws.com/arn%3Aaws%3Acloudformation%3Aap-southeast-2%3A747462550105%3Astack/asg-masked-20200508162554-0b080289adf738030/35459000-90f5-11ea-a7af-0a0ad6464e74/WaitHandle?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20200508T062906Z&X-Amz-SignedHeaders=host&X-Amz-Expires=86399&X-Amz-Credential=masked&X-Amz-Signature=masked However it is encountering this error now: Error signaling CloudFormation: [Errno 403] HTTP Error 403 : AccessDeniedAccess DeniedXYZ...123 There has been no code change **except for using a new Centos 7 AMI**. ", "keywords": ["instance", "change"]}]}, {"Id": "221119605", "PostHistoryTypeId": "1", "PostId": "61674824", "RevisionGUID": "064a226b-32aa-4ad8-86fb-0d09e57e7b44", "CreationDate": "2020-05-08T08:12:43.903", "UserId": "849256", "Text": "What is causing cfn-signal with waithandle.url to get 403 error", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "221119606", "PostHistoryTypeId": "3", "PostId": "61674824", "RevisionGUID": "064a226b-32aa-4ad8-86fb-0d09e57e7b44", "CreationDate": "2020-05-08T08:12:43.903", "UserId": "849256", "Text": "|amazon-web-services|aws-cloudformation|amazon-ami|", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "221408414", "PostHistoryTypeId": "5", "PostId": "61674824", "RevisionGUID": "67072c23-3995-441f-88eb-cb473252bdc4", "CreationDate": "2020-05-12T02:27:55.590", "UserId": "849256", "Comment": "add more info ", "Text": "Good day.\r\n\r\nMy cloudformation stack keeps getting rolled back due to the error for the WaitCondition.\r\n\r\nThe EC2 instance has Userdata which calls custom bootstrap.sh that uses cfn-signal with the waithandle.url (replaced sensitive info with \"masked\"):\r\n\r\n    cfn-signal --success true --http-proxy http://awsproxy:8989 --https-proxy http://awsproxy:8989  --region ap-southeast-2 https://cloudformation-waitcondition-ap-southeast-2.s3-ap-southeast-2.amazonaws.com/arn%3Aaws%3Acloudformation%3Aap-southeast-2%3A747462550105%3Astack/asg-masked-20200508162554-0b080289adf738030/35459000-90f5-11ea-a7af-0a0ad6464e74/WaitHandle?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20200508T062906Z&X-Amz-SignedHeaders=host&X-Amz-Expires=86399&X-Amz-Credential=masked&X-Amz-Signature=masked\r\n\r\nHowever it is encountering this error now:\r\n\r\n    Error signaling CloudFormation: [Errno 403] HTTP Error 403 : AccessDeniedAccess DeniedXYZ...123\r\n\r\nThere has been no code change **except for using a new Centos 7 AMI**.\r\n\r\nHas anyone encountered this error and managed to resolve it?\r\n\r\n**Edit:**\r\nThe userdata has this in the CloudFormation template (which has single-quote surrounding it), where the WAITHANDLE environment variable is used in the cfn-signal command above (the https://cloudformation-waitcondition-ap-southeast-2....):\r\n\r\n    BASH_SCRIPT[8]=\\\"export WAITHANDLE='\", {\"Ref\": \"WaitHandle\"}, \"'\\\"\\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "The EC2 instance has Userdata which calls custom bootstrap.sh that uses cfn-signal with the waithandle.url (replaced sensitive info with \"masked\"): cfn-signal --success true --http-proxy http://awsproxy:8989 --https-proxy http://awsproxy:8989 --region ap-southeast-2 https://cloudformation-waitcondition-ap-southeast-2.s3-ap-southeast-2.amazonaws.com/arn%3Aaws%3Acloudformation%3Aap-southeast-2%3A747462550105%3Astack/asg-masked-20200508162554-0b080289adf738030/35459000-90f5-11ea-a7af-0a0ad6464e74/WaitHandle?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20200508T062906Z&X-Amz-SignedHeaders=host&X-Amz-Expires=86399&X-Amz-Credential=masked&X-Amz-Signature=masked However it is encountering this error now: Error signaling CloudFormation: [Errno 403] HTTP Error 403 : AccessDeniedAccess DeniedXYZ...123 There has been no code change **except for using a new Centos 7 AMI**. ", "keywords": ["instance", "change"]}]}, {"Id": "221597516", "PostHistoryTypeId": "5", "PostId": "61674824", "RevisionGUID": "57b89620-bf26-4139-82fc-0f9b9931cf69", "CreationDate": "2020-05-14T03:34:24.037", "UserId": "849256", "Comment": "deleted 2 characters in body", "Text": "Good day.\r\n\r\nMy cloudformation stack keeps getting rolled back due to the error for the WaitCondition.\r\n\r\nThe EC2 instance has Userdata which calls custom bootstrap.sh that uses cfn-signal with the waithandle.url (replaced sensitive info with \"masked\"):\r\n\r\n    cfn-signal --success true --http-proxy http://proxyAbc:123 --https-proxy http://proxyAbc:123  --region ap-southeast-2 https://cloudformation-waitcondition-ap-southeast-2.s3-ap-southeast-2.amazonaws.com/arn%3Aaws%3Acloudformation%3Aap-southeast-2%3A747462550105%3Astack/asg-masked-20200508162554-0b080289adf738030/35459000-90f5-11ea-a7af-0a0ad6464e74/WaitHandle?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20200508T062906Z&X-Amz-SignedHeaders=host&X-Amz-Expires=86399&X-Amz-Credential=masked&X-Amz-Signature=masked\r\n\r\nHowever it is encountering this error now:\r\n\r\n    Error signaling CloudFormation: [Errno 403] HTTP Error 403 : AccessDeniedAccess DeniedXYZ...123\r\n\r\nThere has been no code change **except for using a new Centos 7 AMI**.\r\n\r\nHas anyone encountered this error and managed to resolve it?\r\n\r\n**Edit:**\r\nThe userdata has this in the CloudFormation template (which has single-quote surrounding it), where the WAITHANDLE environment variable is used in the cfn-signal command above (the https://cloudformation-waitcondition-ap-southeast-2....):\r\n\r\n    BASH_SCRIPT[8]=\\\"export WAITHANDLE='\", {\"Ref\": \"WaitHandle\"}, \"'\\\"\\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "The EC2 instance has Userdata which calls custom bootstrap.sh that uses cfn-signal with the waithandle.url (replaced sensitive info with \"masked\"): cfn-signal --success true --http-proxy http://proxyAbc:123 --https-proxy http://proxyAbc:123 --region ap-southeast-2 https://cloudformation-waitcondition-ap-southeast-2.s3-ap-southeast-2.amazonaws.com/arn%3Aaws%3Acloudformation%3Aap-southeast-2%3A747462550105%3Astack/asg-masked-20200508162554-0b080289adf738030/35459000-90f5-11ea-a7af-0a0ad6464e74/WaitHandle?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20200508T062906Z&X-Amz-SignedHeaders=host&X-Amz-Expires=86399&X-Amz-Credential=masked&X-Amz-Signature=masked However it is encountering this error now: Error signaling CloudFormation: [Errno 403] HTTP Error 403 : AccessDeniedAccess DeniedXYZ...123 There has been no code change **except for using a new Centos 7 AMI**. ", "keywords": ["instance", "change"]}]}], "answers": [{"Id": "61788843", "PostTypeId": "2", "ParentId": "61674824", "CreationDate": "2020-05-14T03:32:57.043", "Score": "4", "Body": "<p>The issue turned out to be due to proxy issue.\nThe proxy being used works before (for years) but now has been broken.\nThis is probably not a general answer as the 403 seems to be to broad, though pay attention to the part where it says AccessDenied (without 'Request has Expired') in any case just answering this in case anyone else encounters it.</p>\n\n<p>For example:</p>\n\n<p><strong>Pre-signed URL expired:</strong></p>\n\n<pre><code>Error signaling CloudFormation: [Errno 403] HTTP Error 403 : \nAccessDeniedRequest has expired863992020-05-15T05:17:56Z2020-05-18T20:41:19Z[somehashvalue]\n</code></pre>\n\n<p><strong>Proxy issue:</strong></p>\n\n<pre><code>Error signaling CloudFormation: [Errno 403] HTTP Error 403 : AccessDeniedAccess Denied[somehashvalue]\n</code></pre>\n", "OwnerUserId": "849256", "LastEditorUserId": "849256", "LastEditDate": "2020-05-19T09:30:26.290", "LastActivityDate": "2020-05-19T09:30:26.290", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "221597475", "PostHistoryTypeId": "2", "PostId": "61788843", "RevisionGUID": "29115114-8504-48c5-a91c-09305c9f144d", "CreationDate": "2020-05-14T03:32:57.043", "UserId": "849256", "Text": "The issue turned out to be due to proxy issue.\r\nThe proxy being used works before (for years) but now has been broken.\r\nThis is probably not a general answer as the 403 seems to be to broad, in any case just answering this in case anyone else encounters it.", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "222013506", "PostHistoryTypeId": "5", "PostId": "61788843", "RevisionGUID": "409b9d59-ef88-45a1-b5a9-63025468df35", "CreationDate": "2020-05-19T09:30:26.290", "UserId": "849256", "Comment": "added 434 characters in body", "Text": "The issue turned out to be due to proxy issue.\r\nThe proxy being used works before (for years) but now has been broken.\r\nThis is probably not a general answer as the 403 seems to be to broad, though pay attention to the part where it says AccessDenied (without 'Request has Expired') in any case just answering this in case anyone else encounters it.\r\n\r\nFor example:\r\n\r\n**Pre-signed URL expired:**\r\n\r\n    Error signaling CloudFormation: [Errno 403] HTTP Error 403 : \r\n    AccessDeniedRequest has expired863992020-05-15T05:17:56Z2020-05-18T20:41:19Z[somehashvalue]\r\n\r\n**Proxy issue:**\r\n\r\n    Error signaling CloudFormation: [Errno 403] HTTP Error 403 : AccessDeniedAccess Denied[somehashvalue]", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "This is probably not a general answer as the 403 seems to be to broad, though pay attention to the part where it says AccessDenied (without 'Request has Expired') in any case just answering this in case anyone else encounters it. ", "keywords": ["pay"]}]}], "filtered-sentences": [{"source": "Body", "text": "This is probably not a general answer as the 403 seems to be to broad, though pay attention to the part where it says AccessDenied (without 'Request has Expired') in any case just answering this in case anyone else encounters it. ", "keywords": ["pay"]}]}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "The EC2 instance has Userdata which calls custom bootstrap.sh that uses cfn-signal with the waithandle.url (replaced sensitive info with \"masked\"): ", "keywords": ["instance"]}, {"source": "Body", "text": "There has been no code change except for using a new Centos 7 AMI. ", "keywords": ["change"]}]}